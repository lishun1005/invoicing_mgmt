"use strict";function lz_rgb32_decompress_new(a,b,c,d,e,f){var j,m,n,o,p,q,r,g=b,h=c.width*(c.height-1),k=0,l=c.data;for(lz_width=c.width,j=a[g++];4*k<l.length;j=a[g++])if(m=h,n=j>>5,o=(31&j)<<8,j>=32){if(n--,6==n)do p=a[g++],n+=p;while(255==p);if(p=a[g++],o+=p,255==p&&7936==o-p&&(o=a[g++]<<8,o+=a[g++],o+=8191),n+=1,(d==LZ_IMAGE_TYPE_RGBA||LZ_IMAGE_TYPE_PLT8>=d)&&(n+=2),o+=1,LZ_IMAGE_TYPE_PLT8>d&&(o=CAST_PLT_DISTANCE(d,o),n=CAST_PLT_DISTANCE(d,n)),m=op_sub(m,o),m==op_sub(h))for(q=m;n;--n){if(d==LZ_IMAGE_TYPE_RGBA)l[4*h+3]=l[4*q+3];else for(i=0;4>i;i++)l[4*h+i]=l[4*q+i];h=op_add(h),k++}else for(;n;--n){if(d==LZ_IMAGE_TYPE_RGBA)l[4*h+3]=l[4*m+3];else for(i=0;4>i;i++)l[4*h+i]=l[4*m+i];h=op_add(h),k++,m=op_add(m)}}else for(j++,d==LZ_IMAGE_TYPE_RGBA?(l[4*h+3]=a[g++],h=op_add(h),k++):LZ_IMAGE_TYPE_PLT8>=d?(r=a[g++],h=COPY_COMP_PIXEL(d,f,r,l,h,!0)):(l[4*h+0]=a[g+2],l[4*h+1]=a[g+1],l[4*h+2]=a[g+0],e&&(l[4*h+3]=255),g+=3,h=op_add(h),k++),--j;j;j--)d==LZ_IMAGE_TYPE_RGBA?(l[4*h+3]=a[g++],h=op_add(h),k++):LZ_IMAGE_TYPE_PLT8>=d?(r=a[g++],h=COPY_COMP_PIXEL(d,f,r,l,h,!0)):(l[4*h+0]=a[g+2],l[4*h+1]=a[g+1],l[4*h+2]=a[g+0],e&&(l[4*h+3]=255),g+=3,h=op_add(h),k++);return g-1}function op_add(a){return 0==(a+1)%lz_width?a+1-2*lz_width:a+1}function op_sub(a,b){var c,d,e;return b?(c=a%lz_width,c>=b?a-b:(d=b-c,e=Math.ceil(d/lz_width),0==d%lz_width?a-c+e*lz_width:a-c+e*lz_width+(lz_width-d%lz_width))):0==a%lz_width?a-1+2*lz_width:a-1}function convert_spice_lz_to_web(a,b){var c,d,e,f;if(b.type===LZ_IMAGE_TYPE_RGB32||b.type===LZ_IMAGE_TYPE_RGBA)d=new Uint8Array(b.data),e=a.createImageData(b.width,b.height),1!=b.top_down?(c=lz_rgb32_decompress_new(d,0,e,LZ_IMAGE_TYPE_RGB32,b.type!=LZ_IMAGE_TYPE_RGBA),b.type==LZ_IMAGE_TYPE_RGBA&&lz_rgb32_decompress_new(d,c,e,LZ_IMAGE_TYPE_RGBA,!1)):(c=lz_rgb32_decompress(d,0,e.data,LZ_IMAGE_TYPE_RGB32,b.type!=LZ_IMAGE_TYPE_RGBA),b.type==LZ_IMAGE_TYPE_RGBA&&lz_rgb32_decompress(d,c,e.data,LZ_IMAGE_TYPE_RGBA,!1));else if(b.type===LZ_IMAGE_TYPE_XXXA)d=new Uint8Array(b.data),e=a.createImageData(b.width,b.height),1!=b.top_down?lz_rgb32_decompress_new(d,0,e,LZ_IMAGE_TYPE_RGBA,!1):lz_rgb32_decompress(d,0,e.data,LZ_IMAGE_TYPE_RGBA,!1);else if(b.type===LZ_IMAGE_TYPE_RGB24)d=new Uint8Array(b.data),e=a.createImageData(b.width,b.height),1!=b.top_down?lz_rgb32_decompress_new(d,0,e,LZ_IMAGE_TYPE_RGB32,b.type!=LZ_IMAGE_TYPE_RGBA):lz_rgb32_decompress(d,0,e.data,LZ_IMAGE_TYPE_RGB32,b.type!=LZ_IMAGE_TYPE_RGBA);else{if(b.type!==LZ_IMAGE_TYPE_PLT1_BE&&b.type!==LZ_IMAGE_TYPE_PLT1_LE&&b.type!==LZ_IMAGE_TYPE_PLT4_BE&&b.type!==LZ_IMAGE_TYPE_PLT4_LE&&b.type!==LZ_IMAGE_TYPE_PLT8)return void 0;if(d=new Uint8Array(b.data),e=a.createImageData(b.stride*PLT_PIXELS_PER_BYTE[b.type],b.height),b.flags&SPICE_BITMAP_FLAGS_PAL_FROM_CACHE){if(f=palette_cache[b.palette_id],!f)return console.log("FIXME-2: did not find palette id : "+b.palette_id+" in palette_cache."),void 0}else f=b.palette,null!=f&&b.flags&SPICE_BITMAP_FLAGS_PAL_CACHE_ME&&(palette_cache[f.unique]=f);c=lz_rgb32_decompress(d,0,e.data,b.type,b.type!=LZ_IMAGE_TYPE_RGBA,f),1!=b.top_down&&e&&(e=data_invalid(a,e))}return e}function data_invalid(a,b){var d,e,f,g,c=a.createImageData(b.width,b.height);for(d=0;d<b.height;d++)for(e=b.height-d-1,f=4*e*b.width,g=4*d*b.width;g<4*(d+1)*b.width;g++)c.data[f]=b.data[g],f++;return c}function lz_rgb32_decompress(a,b,c,d,e,f){var j,l,m,n,o,p,q,g=b,h=0;for(j=a[g++];4*h<c.length;j=a[g++])if(l=h,m=j>>5,n=(31&j)<<8,j>=32){if(m--,6==m)do o=a[g++],m+=o;while(255==o);if(o=a[g++],n+=o,255==o&&7936==n-o&&(n=a[g++]<<8,n+=a[g++],n+=8191),m+=1,(d==LZ_IMAGE_TYPE_RGBA||LZ_IMAGE_TYPE_PLT8>=d)&&(m+=2),n+=1,LZ_IMAGE_TYPE_PLT8>d&&(n=CAST_PLT_DISTANCE(d,n),m=CAST_PLT_DISTANCE(d,m)),l-=n,l==h-1)for(p=l;m;--m){if(d==LZ_IMAGE_TYPE_RGBA)c[4*h+3]=c[4*p+3];else for(i=0;4>i;i++)c[4*h+i]=c[4*p+i];h++}else for(;m;--m){if(d==LZ_IMAGE_TYPE_RGBA)c[4*h+3]=c[4*l+3];else for(i=0;4>i;i++)c[4*h+i]=c[4*l+i];h++,l++}}else for(j++,d==LZ_IMAGE_TYPE_RGBA?(c[4*h+3]=a[g++],h++):LZ_IMAGE_TYPE_PLT8>=d?(q=a[g++],h=COPY_COMP_PIXEL(d,f,q,c,h)):(c[4*h+0]=a[g+2],c[4*h+1]=a[g+1],c[4*h+2]=a[g+0],e&&(c[4*h+3]=255),g+=3,h++),--j;j;j--)d==LZ_IMAGE_TYPE_RGBA?(c[4*h+3]=a[g++],h++):LZ_IMAGE_TYPE_PLT8>=d?(q=a[g++],h=COPY_COMP_PIXEL(d,f,q,c,h)):(c[4*h+0]=a[g+2],c[4*h+1]=a[g+1],c[4*h+2]=a[g+0],e&&(c[4*h+3]=255),g+=3,h++);return g-1}function CAST_PLT_DISTANCE(a,b){switch(a){case LZ_IMAGE_TYPE_PLT1_LE:b*=8;break;case LZ_IMAGE_TYPE_PLT1_BE:b*=8;break;case LZ_IMAGE_TYPE_PLT4_LE:b*=2;break;case LZ_IMAGE_TYPE_PLT4_BE:b*=2;break;case LZ_IMAGE_TYPE_PLT8:}return b}function COPY_COMP_PIXEL(a,b,c,d,e,f){var g,h,j;switch(a){case LZ_IMAGE_TYPE_PLT1_LE:for(b&&(g=get_fill_image(1,1,b.ents[1]),h=get_fill_image(1,1,b.ents[0])),i=0;8>i;i++)1&c>>i?(d[4*e+0]=g.data[0],d[4*e+1]=g.data[1],d[4*e+2]=g.data[2],d[4*e+3]=255):(d[4*e+0]=h.data[0],d[4*e+1]=h.data[1],d[4*e+2]=h.data[2],d[4*e+3]=255),f?e=op_add(e):e++;break;case LZ_IMAGE_TYPE_PLT1_BE:for(b&&(g=get_fill_image(1,1,b.ents[1]),h=get_fill_image(1,1,b.ents[0])),i=7;i>=0;i--)1&c>>i?(d[4*e+0]=g.data[0],d[4*e+1]=g.data[1],d[4*e+2]=g.data[2],d[4*e+3]=255):(d[4*e+0]=h.data[0],d[4*e+1]=h.data[1],d[4*e+2]=h.data[2],d[4*e+3]=255),f?e=op_add(e):e++;break;case LZ_IMAGE_TYPE_PLT4_LE:b&&(j=b.ents[(15&c)%b.num_ents],d[4*e+0]=j>>16,d[4*e+1]=255&j>>8,d[4*e+2]=255&j,d[4*e+3]=255,f?e=op_add(e):e++,j=b.ents[(15&c>>4)%b.num_ents],d[4*e+0]=j>>16,d[4*e+1]=255&j>>8,d[4*e+2]=255&j,d[4*e+3]=255,f?e=op_add(e):e++);break;case LZ_IMAGE_TYPE_PLT4_BE:b&&(j=b.ents[(15&c>>4)%b.num_ents],d[4*e+0]=j>>16,d[4*e+1]=255&j>>8,d[4*e+2]=255&j,d[4*e+3]=255,f?e=op_add(e):e++,j=b.ents[(15&c)%b.num_ents],d[4*e+0]=j>>16,d[4*e+1]=255&j>>8,d[4*e+2]=255&j,d[4*e+3]=255,f?e=op_add(e):e++);break;case LZ_IMAGE_TYPE_PLT8:j=b.ents[c],d[4*e+0]=j>>16,d[4*e+1]=255&j>>8,d[4*e+2]=255&j,d[4*e+3]=255,f?e=op_add(e):e++}return e}var lz_width,PLT_PIXELS_PER_BYTE=[0,8,8,2,2,1];