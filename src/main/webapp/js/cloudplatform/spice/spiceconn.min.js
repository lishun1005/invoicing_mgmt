"use strict";function SpiceConn(a){if(void 0===a||void 0===a.uri||!a.uri)throw new Error("You must specify a uri");if(this.ws=new WebSocket(a.uri,"binary"),!this.ws.binaryType)throw new Error("WebSocket doesn't support binaryType.  Try a different browser.");if(this.connection_id=void 0!==a.connection_id?a.connection_id:0,this.type=void 0!==a.type?a.type:SPICE_CHANNEL_MAIN,this.chan_id=void 0!==a.chan_id?a.chan_id:0,void 0!==a.parent&&(this.parent=a.parent,this.message_id=a.parent.message_id,this.password=a.parent.password),void 0!==a.screen_id&&(this.screen_id=a.screen_id),void 0!==a.dump_id&&(this.dump_id=a.dump_id),void 0!==a.message_id&&(this.message_id=a.message_id),void 0!==a.password&&(this.password=a.password),void 0!==a.onerror&&(this.onerror=a.onerror),void 0!==a.onsuccess&&(this.onsuccess=a.onsuccess),this.state="connecting",this.ws.parent=this,this.wire_reader=new SpiceWireReader(this,this.process_inbound),this.messages_sent=0,this.warnings=[],this.ws.addEventListener("open",function(){DEBUG>0&&console.log(">> WebSockets.onopen"),DEBUG>0&&console.log("id "+this.parent.connection_id+"; type "+this.parent.type),this.parent.send_hdr(),this.parent.wire_reader.request(SpiceLinkHeader.prototype.buffer_size()),this.parent.state="start"}),this.ws.addEventListener("error",function(a){this.parent.log_err(">> WebSockets.onerror"+a.toString()),this.parent.report_error(a)}),this.ws.addEventListener("close",function(a){if(DEBUG>0&&console.log(">> WebSockets.onclose"),DEBUG>0&&console.log("id "+this.parent.connection_id+"; type "+this.parent.type),DEBUG>0&&console.log(a),"closing"!=this.parent.state&&"error"!=this.parent.state&&void 0!==this.parent.onerror){var a;a="connecting"==this.parent.state?new Error("Connection refused."):"start"==this.parent.state||"link"==this.parent.state?new Error("Unexpected protocol mismatch."):"ticket"==this.parent.state?new Error("Bad password."):new Error("Unexpected close while "+this.parent.state),this.parent.onerror(a),this.parent.log_err(a.toString())}}),2==this.ws.readyState||3==this.ws.readyState)throw new Error("Unable to connect to "+a.uri);this.timeout=window.setTimeout(spiceconn_timeout,SPICE_CONNECT_TIMEOUT,this)}function spiceconn_timeout(a){SpiceConn.prototype.handle_timeout.call(a)}SpiceConn.prototype={send_hdr:function(){var c,a=new SpiceLinkHeader,b=new SpiceLinkMess;b.connection_id=this.connection_id,b.channel_type=this.type,b.common_caps.push(1<<SPICE_COMMON_CAP_PROTOCOL_AUTH_SELECTION|1<<SPICE_COMMON_CAP_MINI_HEADER),a.size=b.buffer_size(),c=new ArrayBuffer(a.buffer_size()+b.buffer_size()),a.to_buffer(c),b.to_buffer(c,a.buffer_size()),DEBUG>1&&console.log("Sending header:"),DEBUG>2&&hexdump_buffer(c),this.ws.send(c)},send_ticket:function(a){var c,b=new SpiceLinkAuthTicket;b.auth_mechanism=SPICE_COMMON_CAP_AUTH_SPICE,b.encrypted_data=a,c=new ArrayBuffer(b.buffer_size()),b.to_buffer(c),DEBUG>1&&console.log("Sending ticket:"),DEBUG>2&&hexdump_buffer(c),this.ws.send(c)},send_msg:function(a){var b=new ArrayBuffer(a.buffer_size());a.to_buffer(b),this.messages_sent++,DEBUG>1&&console.log(">> hdr "+this.channel_type()+" type "+a.type+" size "+b.byteLength),DEBUG>2&&hexdump_buffer(b),this.ws.send(b)},process_inbound:function(a,b){var c,d,e,f;DEBUG>2&&console.log(this.type+": processing message of size "+a.byteLength+"; state is "+this.state),"ready"==this.state?void 0==b?(c=new SpiceMiniData(a),c.type>500&&alert("Something has gone very wrong; we think we have message of type "+c.type),0==c.size?(this.process_message(c),this.wire_reader.request(SpiceMiniData.prototype.buffer_size())):(this.wire_reader.request(c.size),this.wire_reader.save_header(c))):(b.data=a,this.process_message(b),this.wire_reader.request(SpiceMiniData.prototype.buffer_size()),this.wire_reader.save_header(void 0)):"start"==this.state?(this.reply_hdr=new SpiceLinkHeader(a),this.reply_hdr.magic!=SPICE_MAGIC?(this.state="error",d=new Error("Error: magic mismatch: "+this.reply_hdr.magic),this.report_error(d)):(this.wire_reader.request(this.reply_hdr.size),this.state="link")):"link"==this.state?(this.reply_link=new SpiceLinkReply(a),this.reply_link.error?(this.state="error",d=new Error("Error: reply link error "+this.reply_link.error),this.report_error(d)):(this.send_ticket(rsa_encrypt(this.reply_link.pub_key,this.password+String.fromCharCode(0))),this.state="ticket",this.wire_reader.request(SpiceLinkAuthReply.prototype.buffer_size()))):"ticket"==this.state&&(this.auth_reply=new SpiceLinkAuthReply(a),this.auth_reply.auth_code==SPICE_LINK_ERR_OK?(DEBUG>0&&console.log(this.type+": Connected"),this.type==SPICE_CHANNEL_DISPLAY&&(e=new SpiceMsgcDisplayInit,f=new SpiceMiniData,f.build_msg(SPICE_MSGC_DISPLAY_INIT,e),DEBUG>0&&console.log("Request display init"),this.send_msg(f)),this.state="ready",this.wire_reader.request(SpiceMiniData.prototype.buffer_size()),this.timeout&&(window.clearTimeout(this.timeout),delete this.timeout)):(this.state="error",d=this.auth_reply.auth_code==SPICE_LINK_ERR_PERMISSION_DENIED?new Error("Permission denied."):new Error("Unexpected link error "+this.auth_reply.auth_code),this.report_error(d)))},process_common_messages:function(a){var b,c,d,e,f;return a.type==SPICE_MSG_SET_ACK?(b=new SpiceMsgSetAck(a.data),this.ack_window=b.window,DEBUG>1&&console.log(this.type+": set ack to "+b.window),this.msgs_until_ack=this.ack_window,c=new SpiceMsgcAckSync(b),d=new SpiceMiniData,d.build_msg(SPICE_MSGC_ACK_SYNC,c),this.send_msg(d),!0):a.type==SPICE_MSG_PING?(DEBUG>1&&console.log("ping!"),e=new SpiceMiniData,e.type=SPICE_MSGC_PONG,a.data&&(e.data=a.data.slice(0,12)),e.size=e.buffer_size(),this.send_msg(e),!0):a.type==SPICE_MSG_NOTIFY?(f=new SpiceMsgNotify(a.data),f.severity==SPICE_NOTIFY_SEVERITY_ERROR?this.log_err(f.message):f.severity==SPICE_NOTIFY_SEVERITY_WARN?this.log_warn(f.message):this.log_info(f.message),!0):!1},process_message:function(a){var b,c;return DEBUG>1&&console.log("<< hdr "+this.channel_type()+" type "+a.type+" size "+(a.data&&a.data.byteLength)),b=this.process_common_messages(a),b||(this.process_channel_message?(b=this.process_channel_message(a),b||this.log_warn(this.type+": Unknown message type "+a.type+"!")):this.log_err(this.type+": No message handlers for this channel; message "+a.type)),void 0!==this.msgs_until_ack&&this.ack_window&&(this.msgs_until_ack--,this.msgs_until_ack<=0&&(this.msgs_until_ack=this.ack_window,c=new SpiceMiniData,c.type=SPICE_MSGC_ACK,this.send_msg(c),DEBUG>1&&console.log(this.type+": sent ack"))),b},channel_type:function(){return this.type==SPICE_CHANNEL_MAIN?"main":this.type==SPICE_CHANNEL_DISPLAY?"display":this.type==SPICE_CHANNEL_INPUTS?"inputs":this.type==SPICE_CHANNEL_CURSOR?"cursor":"unknown-"+this.type},log_info:function(){var b,a=Array.prototype.join.call(arguments," ");console.log(a),this.message_id&&(b=document.createElement("p"),b.appendChild(document.createTextNode(a)),b.className+="spice-message-info",document.getElementById(this.message_id).appendChild(b))},log_warn:function(){var b,a=Array.prototype.join.call(arguments," ");console.log("WARNING: "+a),this.message_id&&(b=document.createElement("p"),b.appendChild(document.createTextNode(a)),b.className+="spice-message-warning",document.getElementById(this.message_id).appendChild(b))},log_err:function(){var b,a=Array.prototype.join.call(arguments," ");console.log("ERROR: "+a),this.message_id&&(b=document.createElement("p"),b.appendChild(document.createTextNode(a)),b.className+="spice-message-error",document.getElementById(this.message_id).appendChild(b))},known_unimplemented:function(a,b){if(!this.warnings[a]||DEBUG>1){var c="";1>=DEBUG&&(c=" [ further notices suppressed ]"),this.log_warn("Unimplemented function "+a+"("+b+")"+c),this.warnings[a]=!0}},report_error:function(a){if(this.log_err(a.toString()),void 0==this.onerror)throw a;this.onerror(a)},report_success:function(a){void 0!=this.onsuccess&&this.onsuccess(a)},cleanup:function(){this.timeout&&(window.clearTimeout(this.timeout),delete this.timeout),this.ws&&(this.ws.close(),this.ws=void 0)},handle_timeout:function(){var a=new Error("Connection timed out.");this.report_error(a)}};