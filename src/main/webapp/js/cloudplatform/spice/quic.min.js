function ceil_log_2(a){if(1===a)return 0;var b=1;for(a-=1;a>>>=1;)b++;return b}function family_init(a,b,c){var d,e,f,g,h,i;for(d=0;b>d;d++)e=c-b,e>bppmask[b-d]&&(e=bppmask[b-d]),f=bppmask[b]+1-(e<<d),a.nGRcodewords[d]=e<<d,a.notGRcwlen[d]=e+ceil_log_2(f),a.notGRprefixmask[d]=bppmask[32-e]>>>0,a.notGRsuffixlen[d]=ceil_log_2(f);for(g=bppmask[b],h=g>>>1,i=0;g>=i;i++)a.xlatU2L[i]=h>=i?i<<1:(g-i<<1)+1;for(i=0;g>=i;i++)a.xlatL2U[i]=1&i?g-(i>>>1):i>>>1}function quic_image_bpc(a){switch(a){case QUIC_IMAGE_TYPE_GRAY:return 8;case QUIC_IMAGE_TYPE_RGB16:return 5;case QUIC_IMAGE_TYPE_RGB24:return 8;case QUIC_IMAGE_TYPE_RGB32:return 8;case QUIC_IMAGE_TYPE_RGBA:return 8;case QUIC_IMAGE_TYPE_INVALID:default:return console.log("quic: bad image type\n"),0}}function cnt_l_zeroes(a){return 4286578688&a?lzeroes[a>>>24]:4294934528&a?8+lzeroes[255&a>>>16]:4294967168&a?16+lzeroes[255&a>>>8]:24+lzeroes[255&a]}function golomb_decoding_8bpc(a,b){var c,d,e;return 0>b||b>family_8bpc.notGRprefixmask[a]?(e=cnt_l_zeroes(b),d=e+1+a,c=e<<a|b>>32-d&bppmask[a]):(d=family_8bpc.notGRcwlen[a],c=family_8bpc.nGRcodewords[a]+(b>>32-d&bppmask[family_8bpc.notGRsuffixlen[a]])),{codewordlen:d,rc:c}}function golomb_code_len_8bpc(a,b){return a<family_8bpc.nGRcodewords[b]?(a>>>b)+1+b:family_8bpc.notGRcwlen[b]}function QuicModel(a){var b,d,e,c=0;switch(this.levels=1<<a,this.n_buckets_ptrs=0,evol){case 1:this.repfirst=3,this.firstsize=1,this.repnext=2,this.mulsize=2;break;case 3:this.repfirst=1,this.firstsize=1,this.repnext=1,this.mulsize=2;break;case 5:this.repfirst=1,this.firstsize=1,this.repnext=1,this.mulsize=4;break;case 0:case 2:case 4:console.log("quic: findmodelparams(): evol value obsolete!!!\n");default:console.log("quic: findmodelparams(): evol out of range!!!\n")}this.n_buckets=0,d=this.repfirst+1,e=this.firstsize;do b=this.n_buckets?c+1:0,--d||(d=this.repnext,e*=this.mulsize),c=b+e-1,c+e>=this.levels&&(c=this.levels-1),this.n_buckets_ptrs||(this.n_buckets_ptrs=this.levels),this.n_buckets++;while(c<this.levels-1)}function QuicBucket(){this.counters=[0,0,0,0,0,0,0,0]}function QuicFamilyStat(){this.buckets_ptrs=[],this.buckets_buf=[]}function QuicChannel(a,b){return this.state=new CommonState,this.family_stat_8bpc=new QuicFamilyStat,this.family_stat_5bpc=new QuicFamilyStat,this.correlate_row={zero:0,row:[]},this.model_8bpc=a,this.model_5bpc=b,this.buckets_ptrs=[],this.family_stat_8bpc.fill_model_structures(this.model_8bpc)?this.family_stat_5bpc.fill_model_structures(this.model_5bpc)?void 0:void 0:void 0}function CommonState(){}function QuicEncoder(){this.rgb_state=new CommonState,this.model_8bpc=new QuicModel(8),this.model_5bpc=new QuicModel(5),this.channels=[];var a;for(a=0;4>a;a++)if(this.channels[a]=new QuicChannel(this.model_8bpc,this.model_5bpc),!this.channels[a])return console.log("quic: failed to create channel"),void 0}function SpiceQuic(){}function convert_spice_quic_to_web(a,b){var d,c=a.createImageData(b.width,b.height);for(d=0;d<4*c.width*c.height;d+=4)c.data[d+0]=b.outptr[d+2],c.data[d+1]=b.outptr[d+1],c.data[d+2]=b.outptr[d+0],c.data[d+3]=b.type!==QUIC_IMAGE_TYPE_RGBA?255:255-b.outptr[d+3];return c}var encoder,i,j,k,l,QUIC_IMAGE_TYPE_INVALID=0,QUIC_IMAGE_TYPE_GRAY=1,QUIC_IMAGE_TYPE_RGB16=2,QUIC_IMAGE_TYPE_RGB24=3,QUIC_IMAGE_TYPE_RGB32=4,QUIC_IMAGE_TYPE_RGBA=5,DEFevol=3,DEFwmimax=6,DEFwminext=2048,need_init=!0,DEFmaxclen=26,evol=DEFevol,wmimax=DEFwmimax,wminext=DEFwminext,family_5bpc={nGRcodewords:[0,0,0,0,0,0,0,0],notGRcwlen:[0,0,0,0,0,0,0,0],notGRprefixmask:[0,0,0,0,0,0,0,0],notGRsuffixlen:[0,0,0,0,0,0,0,0],xlatU2L:[0,0,0,0,0,0,0,0],xlatL2U:[0,0,0,0,0,0,0,0]},family_8bpc={nGRcodewords:[0,0,0,0,0,0,0,0],notGRcwlen:[0,0,0,0,0,0,0,0],notGRprefixmask:[0,0,0,0,0,0,0,0],notGRsuffixlen:[0,0,0,0,0,0,0,0],xlatU2L:[0,0,0,0,0,0,0,0],xlatL2U:[0,0,0,0,0,0,0,0]},bppmask=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535,131071,262143,524287,1048575,2097151,4194303,8388607,16777215,33554431,67108863,134217727,268435455,536870911,1073741823,2147483647,4294967295],zeroLUT=[],besttrigtab=[[550,900,800,700,500,350,300,200,180,180,160],[110,550,900,800,550,400,350,250,140,160,140],[100,120,550,900,700,500,400,300,220,250,160]],J=[0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,5,5,6,6,7,7,8,9,10,11,12,13,14,15],lzeroes=[8,7,6,6,5,5,5,5,4,4,4,4,4,4,4,4,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],tabrand_chaos=[46495042,893548311,794435923,2453991765,2077388039,894197842,1462934312,697534094,1826128012,343623392,2581292719,3811265708,459739748,2638427270,1654964626,101227083,2654850628,3668700691,572794346,2758751005,3445133904,2344099199,3367450297,898927923,3618406352,1606297603,754696453,20823118,2050458127,972590750,3990194068,3305596553,4239238564,1690498157,3015324227,2306127097,1510321853,548392192,971157512,2292288069,1611390505,4086766286,4084927083,1883326811,1891043243,113180603,1107690783,3778825955,3248980775,2443839100,2190866218,1932072870,495393613,1078522166,4051963518,1784694977,1768732442,2146763203,264646923,1474361405,2361552500,296035746,2489922759,2094565616,2409465348,1334241083,72483606,3740181004,4057920662,1734898312,4114662834,574624900,880305546,3258472262,26713132,1571648456,52557195,4043234286,2458021343,676064371,1528437109,64953873,546717185,2709319979,1947039598,2812723004,28691684,286829174,4235176970,3465707163,12526951,2154766700,3165032534,2036061161,3386656087,2301212354,2023576300,1061142336,3105452904,2743866805,3283373992,3397596080,3085489552,3196092395,3210707808,3651022684,925444321,2088074316,230011220,3223248386,533229176,523863486,3028311159,13140218,2538347282,900399636,3000796173,1526771255,3541282854,2992674461,2135722105,389334227,1225164337,3119947809,1803959919,3471171263,704170491,1407019136,1924534819,526887421,168782227,333811993,298623278,4268451686,381087740,2542899140,3266880867,2498950977,200969370,3511909096,3252303004,2268881098,2499828613,2606499854,3163208665,3790254546,1840025712,1319758833,3771674836,519421307,3512796222,1563402978,4284300462,2263719815,715250337,3178437172,2660191010,2982332026,3256309961,2709659997,3434092872,2367065591,69438718,915160508,183164069,3134331940,175242981,2680543346,1421955782,4231173251,1736652874,3990568476,1710820912,2286604440,3464587098,1261907837,1757387321,1128554270,1090050251,2429922486,1288729218,882830086,211637042,1376462063,2147615815,1737974929,798170275,4271572277,4241687072,1638524620,2760366295,1065115089,2097227717,1224023317,1625204849,3383303351,1488272307,2640186157,1649047732,819719707,2615091943,502645401,760628135,4108137983,63606742,1404337880,1865161130,4272996852,1239761976,790984678,3213322601,1917062825,4195069880,1962259360,2111002573,2311983960,1861406170,511141875,2797510619,1331661048,3130608186,147483493,3767089176,2650841450,4096523407,2574446300,1956416337,851468126,3607527519,1811658703,3642821136,832691095,2453312857,933732854,94341217,3393797730,1695907457,2405722077,2877685663,2469507058,2249636341,3988608661,4001245617,825934927,3103985967,1127151177,3691656896,1640967098,2168932645,2830550957,3998822878,3002602893,1509651465,775813869,2599574079,3791574229],rgb32_pixel_pad=3,rgb32_pixel_r=2,rgb32_pixel_g=1,rgb32_pixel_b=0,rgb32_pixel_size=4;if(QuicModel.prototype={n_buckets:0,n_buckets_ptrs:0,repfirst:0,firstsize:0,repnext:0,mulsize:0,levels:0},QuicBucket.prototype={bestcode:0,reste:function(a){this.bestcode=a,this.counters=[0,0,0,0,0,0,0,0]},update_model_8bpc:function(a,b,c){var d,g,e=c-1,f=this.counters[e]+=golomb_code_len_8bpc(b,e);for(d=c-2;d>=0;d--)g=this.counters[d]+=golomb_code_len_8bpc(b,d),f>g&&(e=d,f=g);if(this.bestcode=e,f>a.wm_trigger)for(d=0;c>d;d++)this.counters[d]=this.counters[d]>>>1}},QuicFamilyStat.prototype={fill_model_structures:function(a){var b,g,c=0,d=0,e=a.repfirst+1,f=a.firstsize;do{for(b=d?c+1:0,--e||(e=a.repnext,f*=a.mulsize),c=b+f-1,c+f>=a.levels&&(c=a.levels-1),this.buckets_buf[d]=new QuicBucket,g=b;c>=g;g++)this.buckets_ptrs[g]=this.buckets_buf[d];d++}while(c<a.levels-1);return!0}},QuicChannel.prototype={reste:function(a){var b;if(this.correlate_row={zero:0,row:[]},8==a){for(b=0;b<this.model_8bpc.n_buckets;b++)this.family_stat_8bpc.buckets_buf[b].reste(7);this.buckets_ptrs=this.family_stat_8bpc.buckets_ptrs}else{if(5!=a)return console.log("quic: %s: bad bpc %d\n",__FUNCTION__,a),!1;for(b=0;b<this.model_5bpc.n_buckets;b++)this.family_stat_8bpc.buckets_buf[b].reste(4);this.buckets_ptrs=this.family_stat_5bpc.buckets_ptrs}return this.state.reste(),!0}},CommonState.prototype={waitcnt:0,tabrand_seed:255,wm_trigger:0,wmidx:0,wmileft:wminext,melcstate:0,melclen:0,melcorder:0,set_wm_trigger:function(){var a=this.wmidx;a>10&&(a=10),this.wm_trigger=besttrigtab[Math.floor(evol/2)][a]},reste:function(){this.waitcnt=0,this.tabrand_seed=255,this.wmidx=0,this.wmileft=wminext,this.set_wm_trigger(),this.melcstate=0,this.melclen=J[0],this.melcorder=1<<this.melclen},tabrand:function(){return this.tabrand_seed++,tabrand_chaos[255&this.tabrand_seed]}},QuicEncoder.prototype={type:0,width:0,height:0,io_idx:0,io_available_bits:0,io_word:0,io_next_word:0,io_now:0,io_end:0,rows_completed:0},QuicEncoder.prototype.reste=function(a){return this.rgb_state.reste(),this.io_now=a,this.io_end=this.io_now.length,this.io_idx=0,this.rows_completed=0,!0},QuicEncoder.prototype.read_io_word=function(){if(this.io_idx>=this.io_end)throw"quic: out of data";this.io_next_word=this.io_now[this.io_idx++]|this.io_now[this.io_idx++]<<8|this.io_now[this.io_idx++]<<16|this.io_now[this.io_idx++]<<24},QuicEncoder.prototype.decode_eatbits=function(a){this.io_word=this.io_word<<a;var b=this.io_available_bits-a;b>=0?(this.io_available_bits=b,this.io_word|=this.io_next_word>>>this.io_available_bits):(b=-1*b,this.io_word|=this.io_next_word<<b,this.read_io_word(),this.io_available_bits=32-b,this.io_word|=this.io_next_word>>>this.io_available_bits)},QuicEncoder.prototype.decode_eat32bits=function(){this.decode_eatbits(16),this.decode_eatbits(16)},QuicEncoder.prototype.reste_channels=function(a){var b;for(b=0;4>b;b++)if(!this.channels[b].reste(a))return!1;return!0},QuicEncoder.prototype.quic_decode_begin=function(a){var b,c,d;return this.reste(a)?(this.io_idx=0,this.io_next_word=this.io_now[this.io_idx++]|this.io_now[this.io_idx++]<<8|this.io_now[this.io_idx++]<<16|this.io_now[this.io_idx++]<<24,this.io_word=this.io_next_word,this.io_available_bits=0,b=this.io_word,this.decode_eat32bits(),1128879441!=b?(console.log("quic: bad magic "+b.toString(16)),!1):(c=this.io_word,this.decode_eat32bits(),0!=c?(console.log("quic: bad version "+c.toString(16)),!1):(this.type=this.io_word,this.decode_eat32bits(),this.width=this.io_word,this.decode_eat32bits(),this.height=this.io_word,this.decode_eat32bits(),d=quic_image_bpc(this.type),this.reste_channels(d)?!0:!1))):!1},QuicEncoder.prototype.quic_rgb32_uncompress_row0_seg=function(a,b,c,d,e,f){var g,i,j,h=3;if(a)g=a+this.rgb_state.waitcnt;else{b[rgb32_pixel_pad]=0,i=0;do j=golomb_decoding_8bpc(this.channels[i].buckets_ptrs[this.channels[i].correlate_row.zero].bestcode,this.io_word),this.channels[i].correlate_row.row[0]=j.rc,b[2-i]=255&family_8bpc.xlatL2U[j.rc],this.decode_eatbits(j.codewordlen);while(++i<h);if(this.rgb_state.waitcnt)--this.rgb_state.waitcnt;else{this.rgb_state.waitcnt=this.rgb_state.tabrand()&d,i=0;do this.channels[i].buckets_ptrs[this.channels[i].correlate_row.zero].update_model_8bpc(this.rgb_state,this.channels[i].correlate_row.row[0],e);while(++i<h)}g=++a+this.rgb_state.waitcnt}for(;c>g;){for(;g>=a;a++){b[a*rgb32_pixel_size+rgb32_pixel_pad]=0,i=0;do j=golomb_decoding_8bpc(this.channels[i].buckets_ptrs[this.channels[i].correlate_row.row[a-1]].bestcode,this.io_word),this.channels[i].correlate_row.row[a]=j.rc,b[a*rgb32_pixel_size+(2-i)]=family_8bpc.xlatL2U[j.rc]+b[(a-1)*rgb32_pixel_size+(2-i)]&f,this.decode_eatbits(j.codewordlen);while(++i<h)}i=0;do this.channels[i].buckets_ptrs[this.channels[i].correlate_row.row[g-1]].update_model_8bpc(this.rgb_state,this.channels[i].correlate_row.row[g],e);while(++i<h);g=a+(this.rgb_state.tabrand()&d)}for(;c>a;a++){b[a*rgb32_pixel_size+rgb32_pixel_pad]=0,i=0;do j=golomb_decoding_8bpc(this.channels[i].buckets_ptrs[this.channels[i].correlate_row.row[a-1]].bestcode,this.io_word),this.channels[i].correlate_row.row[a]=j.rc,b[a*rgb32_pixel_size+(2-i)]=family_8bpc.xlatL2U[j.rc]+b[(a-1)*rgb32_pixel_size+(2-i)]&f,this.decode_eatbits(j.codewordlen);while(++i<h)}this.rgb_state.waitcnt=g-c},QuicEncoder.prototype.quic_rgb32_uncompress_row0=function(a){for(var b=8,c=255,d=0,e=this.width;wmimax>this.rgb_state.wmidx&&this.rgb_state.wmileft<=e;)this.rgb_state.wmileft&&(this.quic_rgb32_uncompress_row0_seg(d,a,d+this.rgb_state.wmileft,bppmask[this.rgb_state.wmidx],b,c),d+=this.rgb_state.wmileft,e-=this.rgb_state.wmileft),this.rgb_state.wmidx++,this.rgb_state.set_wm_trigger(),this.rgb_state.wmileft=wminext;e&&(this.quic_rgb32_uncompress_row0_seg(d,a,d+e,bppmask[this.rgb_state.wmidx],b,c),wmimax>this.rgb_state.wmidx&&(this.rgb_state.wmileft-=e))},QuicEncoder.prototype.quic_rgb32_uncompress_row_seg=function(a,b,c,d,e,f){var i,m,n,o,p,q,r,s,g=3,h=bppmask[this.rgb_state.wmidx],j=0,k=0,l=0;if(c)k=c+this.rgb_state.waitcnt;else{b[rgb32_pixel_pad]=0,m=0;do i=golomb_decoding_8bpc(this.channels[m].buckets_ptrs[this.channels[m].correlate_row.zero].bestcode,this.io_word),this.channels[m].correlate_row.row[0]=i.rc,b[2-m]=family_8bpc.xlatL2U[this.channels[m].correlate_row.row[0]]+a[2-m]&f,this.decode_eatbits(i.codewordlen);while(++m<g);if(this.rgb_state.waitcnt)--this.rgb_state.waitcnt;else{this.rgb_state.waitcnt=this.rgb_state.tabrand()&h,m=0;do this.channels[m].buckets_ptrs[this.channels[m].correlate_row.zero].update_model_8bpc(this.rgb_state,this.channels[m].correlate_row.row[0],e);while(++m<g)}k=++c+this.rgb_state.waitcnt}for(;;){for(n=0;d>k&&!n;){for(;k>=c&&!n;c++){if(o=c*rgb32_pixel_size,p=(c-1)*rgb32_pixel_size,q=(c-2)*rgb32_pixel_size,a[p+rgb32_pixel_r]==a[o+rgb32_pixel_r]&&a[p+rgb32_pixel_g]==a[o+rgb32_pixel_g]&&a[p+rgb32_pixel_b]==a[o+rgb32_pixel_b]&&j!=c&&c>2&&b[p+rgb32_pixel_r]==b[q+rgb32_pixel_r]&&b[p+rgb32_pixel_g]==b[q+rgb32_pixel_g]&&b[p+rgb32_pixel_b]==b[q+rgb32_pixel_b]){for(this.rgb_state.waitcnt=k-c,j=c,l=c+this.decode_run(this.rgb_state);l>c;c++)o=c*rgb32_pixel_size,p=(c-1)*rgb32_pixel_size,b[o+rgb32_pixel_pad]=0,b[o+rgb32_pixel_r]=b[p+rgb32_pixel_r],b[o+rgb32_pixel_g]=b[p+rgb32_pixel_g],b[o+rgb32_pixel_b]=b[p+rgb32_pixel_b];if(c==d)return;k=c+this.rgb_state.waitcnt,n=1;break}m=0,b[o+rgb32_pixel_pad]=0;do r=this.channels[m],s=r.correlate_row,i=golomb_decoding_8bpc(r.buckets_ptrs[s.row[c-1]].bestcode,this.io_word),s.row[c]=i.rc,b[o+(2-m)]=family_8bpc.xlatL2U[i.rc]+(b[p+(2-m)]+a[o+(2-m)]>>1)&f,this.decode_eatbits(i.codewordlen);while(++m<g)}if(n)break;m=0;do this.channels[m].buckets_ptrs[this.channels[m].correlate_row.row[k-1]].update_model_8bpc(this.rgb_state,this.channels[m].correlate_row.row[k],e);while(++m<g);k=c+(this.rgb_state.tabrand()&h)}for(;d>c&&!n;c++){if(o=c*rgb32_pixel_size,p=(c-1)*rgb32_pixel_size,q=(c-2)*rgb32_pixel_size,a[p+rgb32_pixel_r]==a[o+rgb32_pixel_r]&&a[p+rgb32_pixel_g]==a[o+rgb32_pixel_g]&&a[p+rgb32_pixel_b]==a[o+rgb32_pixel_b]&&j!=c&&c>2&&b[p+rgb32_pixel_r]==b[q+rgb32_pixel_r]&&b[p+rgb32_pixel_g]==b[q+rgb32_pixel_g]&&b[p+rgb32_pixel_b]==b[q+rgb32_pixel_b]){for(this.rgb_state.waitcnt=k-c,j=c,l=c+this.decode_run(this.rgb_state);l>c;c++)o=c*rgb32_pixel_size,p=(c-1)*rgb32_pixel_size,b[o+rgb32_pixel_pad]=0,b[o+rgb32_pixel_r]=b[p+rgb32_pixel_r],b[o+rgb32_pixel_g]=b[p+rgb32_pixel_g],b[o+rgb32_pixel_b]=b[p+rgb32_pixel_b];if(c==d)return;k=c+this.rgb_state.waitcnt,n=1;break}b[o+rgb32_pixel_pad]=0,m=0;do i=golomb_decoding_8bpc(this.channels[m].buckets_ptrs[this.channels[m].correlate_row.row[c-1]].bestcode,this.io_word),this.channels[m].correlate_row.row[c]=i.rc,b[o+(2-m)]=family_8bpc.xlatL2U[i.rc]+(b[p+(2-m)]+a[o+(2-m)]>>1)&f,this.decode_eatbits(i.codewordlen);while(++m<g)}if(!n)return this.rgb_state.waitcnt=k-d,void 0}},QuicEncoder.prototype.decode_run=function(a){for(var c,d,e,b=0;;){for(d=255&~(this.io_word>>>24)>>>0,e=zeroLUT[d],c=1;e>=c;c++)b+=a.melcorder,a.melcstate<32&&(a.melclen=J[++a.melcstate],a.melcorder=1<<a.melclen);if(8!=e){this.decode_eatbits(e+1);break}this.decode_eatbits(8)}return a.melclen&&(b+=this.io_word>>>32-a.melclen,this.decode_eatbits(a.melclen)),a.melcstate&&(a.melclen=J[--a.melcstate],a.melcorder=1<<a.melclen),b},QuicEncoder.prototype.quic_rgb32_uncompress_row=function(a,b){for(var c=8,d=255,e=0,f=this.width;wmimax>this.rgb_state.wmidx&&this.rgb_state.wmileft<=f;)this.rgb_state.wmileft&&(this.quic_rgb32_uncompress_row_seg(a,b,e,e+this.rgb_state.wmileft,c,d),e+=this.rgb_state.wmileft,f-=this.rgb_state.wmileft),this.rgb_state.wmidx++,this.rgb_state.set_wm_trigger(),this.rgb_state.wmileft=wminext;f&&(this.quic_rgb32_uncompress_row_seg(a,b,e,e+f,c,d),wmimax>this.rgb_state.wmidx&&(this.rgb_state.wmileft-=f))},QuicEncoder.prototype.quic_four_uncompress_row0_seg=function(a,b,c,d,e,f,g,h){var i,j,k;for(0==b?(j=golomb_decoding_8bpc(a.buckets_ptrs[c.zero].bestcode,this.io_word),c.row[0]=j.rc,d[rgb32_pixel_pad]=family_8bpc.xlatL2U[j.rc],this.decode_eatbits(j.codewordlen),a.state.waitcnt?--a.state.waitcnt:(a.state.waitcnt=a.state.tabrand()&f,a.buckets_ptrs[c.zero].update_model_8bpc(a.state,c.row[0],g)),i=++b+a.state.waitcnt):i=b+a.state.waitcnt;e>i;){for(;i>=b;b++)k=a.buckets_ptrs[c.row[b-1]],j=golomb_decoding_8bpc(k.bestcode,this.io_word),c.row[b]=j.rc,d[b*rgb32_pixel_size+rgb32_pixel_pad]=family_8bpc.xlatL2U[j.rc]+d[(b-1)*rgb32_pixel_size+rgb32_pixel_pad]&h,this.decode_eatbits(j.codewordlen);k.update_model_8bpc(a.state,c.row[i],g),i=b+(a.state.tabrand()&f)}for(;e>b;b++)j=golomb_decoding_8bpc(a.buckets_ptrs[c.row[b-1]].bestcode,this.io_word),c.row[b]=j.rc,d[b*rgb32_pixel_size+rgb32_pixel_pad]=family_8bpc.xlatL2U[j.rc]+d[(b-1)*rgb32_pixel_size+rgb32_pixel_pad]&h,this.decode_eatbits(j.codewordlen);a.state.waitcnt=i-e},QuicEncoder.prototype.quic_four_uncompress_row0=function(a,b){for(var c=8,d=255,e=a.correlate_row,f=0,g=this.width;wmimax>a.state.wmidx&&a.state.wmileft<=g;)a.state.wmileft&&(this.quic_four_uncompress_row0_seg(a,f,e,b,f+a.state.wmileft,bppmask[a.state.wmidx],c,d),f+=a.state.wmileft,g-=a.state.wmileft),a.state.wmidx++,a.state.set_wm_trigger(),a.state.wmileft=wminext;g&&(this.quic_four_uncompress_row0_seg(a,f,e,b,f+g,bppmask[a.state.wmidx],c,d),wmimax>a.state.wmidx&&(a.state.wmileft-=g))},QuicEncoder.prototype.quic_four_uncompress_row_seg=function(a,b,c,d,e,f,g,h){var j,l,m,n,o,p,q,r,i=bppmask[a.state.wmidx],k=0;for(0==e?(m=golomb_decoding_8bpc(a.buckets_ptrs[b.zero].bestcode,this.io_word),b.row[0]=m.rc,d[rgb32_pixel_pad]=family_8bpc.xlatL2U[m.rc]+c[rgb32_pixel_pad]&h,this.decode_eatbits(m.codewordlen),a.state.waitcnt?--a.state.waitcnt:(a.state.waitcnt=a.state.tabrand()&i,a.buckets_ptrs[b.zero].update_model_8bpc(a.state,b.row[0],g)),j=++e+a.state.waitcnt):j=e+a.state.waitcnt;;){for(n=0;f>j&&!n;){for(;j>=e&&!n;e++){if(p=e*rgb32_pixel_size,q=(e-1)*rgb32_pixel_size,r=(e-2)*rgb32_pixel_size,c[q+rgb32_pixel_pad]==c[p+rgb32_pixel_pad]&&k!=e&&e>2&&d[q+rgb32_pixel_pad]==d[r+rgb32_pixel_pad]){for(a.state.waitcnt=j-e,k=e,l=e+this.decode_run(a.state);l>e;e++)p=e*rgb32_pixel_size,q=(e-1)*rgb32_pixel_size,d[p+rgb32_pixel_pad]=d[q+rgb32_pixel_pad];if(e==f)return;j=e+a.state.waitcnt,n=1;break}o=a.buckets_ptrs[b.row[e-1]],m=golomb_decoding_8bpc(o.bestcode,this.io_word),b.row[e]=m.rc,d[p+rgb32_pixel_pad]=family_8bpc.xlatL2U[m.rc]+(d[q+rgb32_pixel_pad]+c[p+rgb32_pixel_pad]>>1)&h,this.decode_eatbits(m.codewordlen)}if(n)break;o.update_model_8bpc(a.state,b.row[j],g),j=e+(a.state.tabrand()&i)}for(;f>e&&!n;e++){if(p=e*rgb32_pixel_size,q=(e-1)*rgb32_pixel_size,r=(e-2)*rgb32_pixel_size,c[q+rgb32_pixel_pad]==c[p+rgb32_pixel_pad]&&k!=e&&e>2&&d[q+rgb32_pixel_pad]==d[r+rgb32_pixel_pad]){for(a.state.waitcnt=j-e,k=e,l=e+this.decode_run(a.state);l>e;e++)p=e*rgb32_pixel_size,q=(e-1)*rgb32_pixel_size,d[p+rgb32_pixel_pad]=d[q+rgb32_pixel_pad];if(e==f)return;j=e+a.state.waitcnt,n=1;break}m=golomb_decoding_8bpc(a.buckets_ptrs[b.row[e-1]].bestcode,this.io_word),b.row[e]=m.rc,d[p+rgb32_pixel_pad]=family_8bpc.xlatL2U[m.rc]+(d[q+rgb32_pixel_pad]+c[p+rgb32_pixel_pad]>>1)&h,this.decode_eatbits(m.codewordlen)}if(!n)return a.state.waitcnt=j-f,void 0}},QuicEncoder.prototype.quic_four_uncompress_row=function(a,b,c){for(var d=8,e=255,f=a.correlate_row,g=0,h=this.width;wmimax>a.state.wmidx&&a.state.wmileft<=h;)a.state.wmileft&&(this.quic_four_uncompress_row_seg(a,f,b,c,g,g+a.state.wmileft,d,e),g+=a.state.wmileft,h-=a.state.wmileft),a.state.wmidx++,a.state.set_wm_trigger(),a.state.wmileft=wminext;h&&(this.quic_four_uncompress_row_seg(a,f,b,c,g,g+h,d,e),wmimax>a.state.wmidx&&(a.state.wmileft-=h))},QuicEncoder.prototype.quic_decode=function(a,b){var c,d;switch(this.type){case QUIC_IMAGE_TYPE_RGB32:case QUIC_IMAGE_TYPE_RGB24:for(this.channels[0].correlate_row.zero=0,this.channels[1].correlate_row.zero=0,this.channels[2].correlate_row.zero=0,this.quic_rgb32_uncompress_row0(a),this.rows_completed++,c=1;c<this.height;c++)d=a,a=d.subarray(b),this.channels[0].correlate_row.zero=this.channels[0].correlate_row.row[0],this.channels[1].correlate_row.zero=this.channels[1].correlate_row.row[0],this.channels[2].correlate_row.zero=this.channels[2].correlate_row.row[0],this.quic_rgb32_uncompress_row(d,a),this.rows_completed++;break;case QUIC_IMAGE_TYPE_RGB16:return console.log("quic: unsupported output format\n"),!1;case QUIC_IMAGE_TYPE_RGBA:for(this.channels[0].correlate_row.zero=0,this.channels[1].correlate_row.zero=0,this.channels[2].correlate_row.zero=0,this.quic_rgb32_uncompress_row0(a),this.channels[3].correlate_row.zero=0,this.quic_four_uncompress_row0(this.channels[3],a),this.rows_completed++,c=1;c<this.height;c++)d=a,a=d.subarray(b),this.channels[0].correlate_row.zero=this.channels[0].correlate_row.row[0],this.channels[1].correlate_row.zero=this.channels[1].correlate_row.row[0],this.channels[2].correlate_row.zero=this.channels[2].correlate_row.row[0],this.quic_rgb32_uncompress_row(d,a),this.channels[3].correlate_row.zero=this.channels[3].correlate_row.row[0],this.quic_four_uncompress_row(encoder.channels[3],d,a),this.rows_completed++;break;case QUIC_IMAGE_TYPE_GRAY:return console.log("quic: unsupported output format\n"),!1;case QUIC_IMAGE_TYPE_INVALID:default:return console.log("quic: bad image type\n"),!1}return!0},QuicEncoder.prototype.simple_quic_decode=function(a){var c,b=4;return this.quic_decode_begin(a)?this.type!=QUIC_IMAGE_TYPE_RGB32&&this.type!=QUIC_IMAGE_TYPE_RGB24&&this.type!=QUIC_IMAGE_TYPE_RGBA?void 0:(c=new Uint8Array(4*this.width*this.height),c[0]=69,this.quic_decode(c,this.width*b)?c:void 0):void 0},SpiceQuic.prototype={from_dv:function(a,b,c){if(!encoder)throw"quic: no quic encoder";this.data_size=a.getUint32(b,!0),b+=4;var d=new Uint8Array(c.slice(b));return this.outptr=encoder.simple_quic_decode(d),this.outptr&&(this.type=encoder.type,this.width=encoder.width,this.height=encoder.height),b+=d.length}},need_init){for(need_init=!1,family_init(family_8bpc,8,DEFmaxclen),family_init(family_5bpc,5,DEFmaxclen),j=k=1,l=8,i=0;256>i;++i)zeroLUT[i]=l,--k,0==k&&(k=j,--l,j*=2);if(encoder=new QuicEncoder,!encoder)throw"quic: failed to create encoder"}