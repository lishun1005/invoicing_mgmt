"use strict";function convert_spice_bitmap_to_web(a,b){var c,d,e,f,g,h,j;if(!b)return void 0;if(g=new Uint8Array(b.data),b.format==SPICE_BITMAP_FMT_32BIT||b.format==SPICE_BITMAP_FMT_RGBA)for(c=a.createImageData(b.x,b.y),d=(b.y-1)*b.stride,e=0;e<b.y*b.stride;d-=b.stride)for(f=0;f<4*b.x;f+=4,e+=4)c.data[d+f+0]=g[e+2],c.data[d+f+1]=g[e+1],c.data[d+f+2]=g[e+0],c.data[d+f+3]=b.format==SPICE_BITMAP_FMT_32BIT?255:g[e];else if(b.format==SPICE_BITMAP_FMT_24BIT)for(c=a.createImageData(b.x,b.y),e=0,i=0;e<b.y*b.stride;)for(f=0;f<b.x;f++,i++,e+=3)c.data[e+0+i]=g[e+2],c.data[e+1+i]=g[e+1],c.data[e+2+i]=g[e+0],c.data[e+3+i]=255;else if(b.format==SPICE_BITMAP_FMT_1BIT_BE){if(c=a.createImageData(b.x,b.y),h=b.stride,b.flags&SPICE_BITMAP_FLAGS_PAL_FROM_CACHE?j=palette_cache[b.palette_id]:b.flags&SPICE_BITMAP_FLAGS_PAL_CACHE_ME&&(j=b.palette,null!=j&&b.flags&SPICE_BITMAP_FLAGS_PAL_CACHE_ME&&(palette_cache[j.unique]=j)),null==j)return console.log("FIXME-2: did not find palette id : "+b.palette_id+" in palette_cache."),void 0;bitmap_1be_32_to_32(c.data,g,h,b.x,b.y,b.flags,j)}else if(b.format==SPICE_BITMAP_FMT_4BIT_BE){if(c=a.createImageData(b.x,b.y),h=b.stride,b.flags&SPICE_BITMAP_FLAGS_PAL_FROM_CACHE?j=palette_cache[b.palette_id]:b.flags&SPICE_BITMAP_FLAGS_PAL_CACHE_ME&&(j=b.palette,null!=j&&b.flags&SPICE_BITMAP_FLAGS_PAL_CACHE_ME&&(palette_cache[j.unique]=j)),null==j)return console.log("FIXME-2: did not find palette id : "+b.palette_id+" in palette_cache."),void 0;bitmap_4be_32_to_32(c.data,g,h,b.x,b.y,b.flags,j)}else{if(b.format!=SPICE_BITMAP_FMT_8BIT)return void 0;if(c=a.createImageData(b.x,b.y),h=b.stride,b.flags&SPICE_BITMAP_FLAGS_PAL_FROM_CACHE?j=palette_cache[b.palette_id]:b.flags&SPICE_BITMAP_FLAGS_PAL_CACHE_ME&&(j=b.palette,null!=j&&b.flags&SPICE_BITMAP_FLAGS_PAL_CACHE_ME&&(palette_cache[j.unique]=j)),null==j)return console.log("FIXME-2: did not find palette id : "+b.palette_id+" in palette_cache."),void 0;bitmap_8_32_to_32(c.data,g,h,b.x,b.y,b.flags,j)}return c}function bitmap_4be_32_to_32(a,b,c,d,e,f,g){var j,k,l,m,n,o,h=4*d,i=0;if(f&SPICE_BITMAP_FLAGS_TOP_DOWN||(i+=h*(e-1),h=-h),j=0,k=j+e*c,g)for(;j!=k;j+=c,i+=h){for(l=i,m=j,n=0;d>>1>n;n++)o=g.ents[15&b[m]>>4],a[l+0]=o>>16,a[l+1]=255&o>>8,a[l+2]=255&o,l+=4,o=g.ents[15&b[m++]],a[l+0]=o>>16,a[l+1]=255&o>>8,a[l+2]=255&o,l+=4;1&d&&(o=g.ents[15&b[m]>>4],a[l+0]=o>>16,a[l+1]=255&o>>8,a[l+2]=255&o)}}function bitmap_8_32_to_32(a,b,c,d,e,f,g){var j,k,l,m,n,o,h=4*d,i=0;if(f&SPICE_BITMAP_FLAGS_TOP_DOWN||(i+=h*(e-1),h=-h),j=0,k=j+e*c,g)for(;j!=k;j+=c,i+=h)for(l=i,m=j,n=m+d;n>m;)o=g.ents[b[m++]],a[l+0]=o>>16,a[l+1]=255&o>>8,a[l+2]=255&o,l+=4}function bitmap_1be_32_to_32(a,b,c,d,e,f,g){var j,k,l,m,n,o,h=4*d,i=0;for(f&SPICE_BITMAP_FLAGS_TOP_DOWN||(i+=h*(e-1),h=-h),j=0,k=j+e*c,l=g.ents[1],m=g.ents[0];j!=k;j+=c,i+=h)for(n=i,o=0;d>o;o++)test_bit_be(b,j,o)?(a[n+0]=l>>16,a[n+1]=255&l>>8,a[n+2]=255&l,a[n+3]=0):(a[n+0]=m>>16,a[n+1]=255&m>>8,a[n+2]=255&m,a[n+3]=0),n+=4}function get_fill_image(a,b,c){var e,d=document.createElement("canvas");return d.setAttribute("width",a),d.setAttribute("height",b),c=16777215&c,e="rgb("+(c>>16)+", "+(255&c>>8)+", "+(255&c)+")",d.getContext("2d").fillStyle=e,d.getContext("2d").fillRect(0,0,a,b),d.getContext("2d").getImageData(0,0,a,b)}function test_bit_be(a,b,c){return!!(a[b+(c>>3)]&128>>(7&c))}var palette_cache={};