"use strict";function SpiceInputsConn(){SpiceConn.apply(this,arguments),this.mousex=void 0,this.mousey=void 0,this.button_state=0,this.waiting_for_ack=0}function handle_mousemove(a){var c,b=new SpiceMiniData;this.sc.mouse_mode==SPICE_MOUSE_MODE_CLIENT?(c=new SpiceMsgcMousePosition(this.sc,a),b.build_msg(SPICE_MSGC_INPUTS_MOUSE_POSITION,c)):(c=new SpiceMsgcMouseMotion(this.sc,a),b.build_msg(SPICE_MSGC_INPUTS_MOUSE_MOTION,c)),this.sc&&this.sc.inputs&&"ready"===this.sc.inputs.state&&(this.sc.inputs.waiting_for_ack<2*SPICE_INPUT_MOTION_ACK_BUNCH?(this.sc.inputs.send_msg(b),this.sc.inputs.waiting_for_ack++):DEBUG>0&&this.sc.log_info("Discarding mouse motion")),this.sc&&this.sc.cursor&&this.sc.cursor.spice_simulated_cursor&&(this.sc.cursor.spice_simulated_cursor.style.display="block",this.sc.cursor.spice_simulated_cursor.style.left=a.pageX-this.sc.cursor.spice_simulated_cursor.spice_hot_x+"px",this.sc.cursor.spice_simulated_cursor.style.top=a.pageY-this.sc.cursor.spice_simulated_cursor.spice_hot_y+"px",a.preventDefault())}function handle_mousedown(a){var b=new SpiceMsgcMousePress(this.sc,a),c=new SpiceMiniData;c.build_msg(SPICE_MSGC_INPUTS_MOUSE_PRESS,b),this.sc&&this.sc.inputs&&"ready"===this.sc.inputs.state&&this.sc.inputs.send_msg(c),a.preventDefault()}function handle_contextmenu(a){return a.preventDefault(),!1}function handle_mouseup(a){var b=new SpiceMsgcMouseRelease(this.sc,a),c=new SpiceMiniData;c.build_msg(SPICE_MSGC_INPUTS_MOUSE_RELEASE,b),this.sc&&this.sc.inputs&&"ready"===this.sc.inputs.state&&this.sc.inputs.send_msg(c),a.preventDefault()}function handle_mousewheel(a){var d,b=new SpiceMsgcMousePress,c=new SpiceMsgcMouseRelease;b.button=c.button=(a.wheelDelta|-a.detail)>0?SPICE_MOUSE_BUTTON_UP:SPICE_MOUSE_BUTTON_DOWN,b.buttons_state=0,c.buttons_state=0,d=new SpiceMiniData,d.build_msg(SPICE_MSGC_INPUTS_MOUSE_PRESS,b),this.sc&&this.sc.inputs&&"ready"===this.sc.inputs.state&&this.sc.inputs.send_msg(d),d.build_msg(SPICE_MSGC_INPUTS_MOUSE_RELEASE,c),this.sc&&this.sc.inputs&&"ready"===this.sc.inputs.state&&this.sc.inputs.send_msg(d),a.preventDefault()}function handle_keydown(a){var b=new SpiceMsgcKeyDown(a),c=new SpiceMiniData;check_and_update_modifiers(a,b.code,this.sc),replice_combination_keydown(a,b,this.sc)||(c.build_msg(SPICE_MSGC_INPUTS_KEY_DOWN,b),this.sc&&this.sc.inputs&&"ready"===this.sc.inputs.state&&this.sc.inputs.send_msg(c),b.code!=KEY_F11&&a.preventDefault())}function handle_keyup(a){var b=new SpiceMsgcKeyUp(a),c=new SpiceMiniData;check_and_update_modifiers(a,b.code,this.sc),replice_combination_keyup(a,b,this.sc)||(c.build_msg(SPICE_MSGC_INPUTS_KEY_UP,b),this.sc&&this.sc.inputs&&"ready"===this.sc.inputs.state&&this.sc.inputs.send_msg(c),b.code!=KEY_F11&&a.preventDefault())}function sendCtrlAltDel(){var a,b;sc&&sc.inputs&&"ready"===sc.inputs.state&&(a=new SpiceMsgcKeyDown,b=new SpiceMiniData,update_modifier(!0,KEY_LCtrl,sc),update_modifier(!0,KEY_Alt,sc),a.code=KEY_KP_Decimal,b.build_msg(SPICE_MSGC_INPUTS_KEY_DOWN,a),sc.inputs.send_msg(b),b.build_msg(SPICE_MSGC_INPUTS_KEY_UP,a),sc.inputs.send_msg(b),0==Ctrl_state&&update_modifier(!1,KEY_LCtrl,sc),0==Alt_state&&update_modifier(!1,KEY_Alt,sc))}function sendMenu(){if(sc&&sc.inputs&&"ready"===sc.inputs.state){var a=93;update_modifier(!0,keycode_to_start_scan(a),sc),update_modifier(!1,keycode_to_end_scan(a),sc)}}function sendMeta_(a){if(sc&&sc.inputs&&"ready"===sc.inputs.state){var b=91;update_modifier(!0,keycode_to_start_scan(b),sc),update_modifier(!0,a,sc),update_modifier(!1,keycode_to_end_scan(b),sc)}}function sendLMeta(){if(sc&&sc.inputs&&"ready"===sc.inputs.state){var a=91;update_modifier(!0,keycode_to_start_scan(a),sc),update_modifier(!1,keycode_to_end_scan(a),sc)}}function update_modifier(a,b,c){var e,d=new SpiceMiniData;a?(e=new SpiceMsgcKeyDown,e.code=b,d.build_msg(SPICE_MSGC_INPUTS_KEY_DOWN,e)):(e=new SpiceMsgcKeyUp,e.code=128|b,d.build_msg(SPICE_MSGC_INPUTS_KEY_UP,e)),c.inputs.send_msg(d)}function check_and_update_modifiers(a,b,c){-1===Shift_state&&(Shift_state=a.shiftKey,Ctrl_state=a.ctrlKey,Alt_state=a.altKey,Meta_state=a.metaKey),b===KEY_ShiftL?Shift_state=!0:b===KEY_Alt?Alt_state=!0:b===KEY_LCtrl?Ctrl_state=!0:57525===b?Meta_state=!0:b===(128|KEY_ShiftL)?Shift_state=!1:b===(128|KEY_Alt)?Alt_state=!1:b===(128|KEY_LCtrl)?Ctrl_state=!1:57525===b&&(Meta_state=!1),c&&c.inputs&&"ready"===c.inputs.state&&(Shift_state!=a.shiftKey&&(console.log("Shift state out of sync"),update_modifier(a.shiftKey,KEY_ShiftL,c),Shift_state=a.shiftKey),Alt_state!=a.altKey&&(console.log("Alt state out of sync"),update_modifier(a.altKey,KEY_Alt,c),Alt_state=a.altKey),Ctrl_state!=a.ctrlKey&&(console.log("Ctrl state out of sync"),update_modifier(a.ctrlKey,KEY_LCtrl,c),Ctrl_state=a.ctrlKey),Meta_state!=a.metaKey&&(console.log("Meta state out of sync"),update_modifier(a.metaKey,57525,c),Meta_state=a.metaKey))}function replice_combination_keydown(a,b,c){return 1==Ctrl_state&&1==Alt_state&&b.code==keycode_to_start_scan(45)?(sendCtrlAltDel(),a.preventDefault(),!0):93==a.keyCode?(sendMenu(),a.preventDefault(),!0):91==a.keyCode||92==a.keyCode?(sendLMeta(),a.preventDefault(),!0):1==Alt_state&&b.code==KEY_Tilde?(update_modifier(!0,KEY_Tab,c),a.preventDefault(),!0):1!=Ctrl_state||b.code!=KEY_E&&b.code!=KEY_M&&b.code!=KEY_R?!1:(update_modifier(!1,KEY_ShiftL,c),update_modifier(!1,KEY_LCtrl,c),update_modifier(!1,KEY_Alt,c),sendMeta_(b.code),1==Ctrl_state&&update_modifier(!0,KEY_ShiftL,c),1==Shift_state&&update_modifier(!0,KEY_LCtrl,c),1==Alt_state&&update_modifier(!0,KEY_Alt,c),a.preventDefault(),!0)}function replice_combination_keyup(a,b,c){return 1==Alt_state&&b.code==KEY_Tilde?(update_modifier(!1,KEY_Tab,c),a.preventDefault(),!0):!1}var Shift_state=-1,Ctrl_state=-1,Alt_state=-1,Meta_state=-1;SpiceInputsConn.prototype=Object.create(SpiceConn.prototype),SpiceInputsConn.prototype.process_channel_message=function(a){var b,c;return a.type==SPICE_MSG_INPUTS_INIT?(b=new SpiceMsgInputsInit(a.data),this.keyboard_modifiers=b.keyboard_modifiers,DEBUG>1&&console.log("MsgInputsInit - modifier "+this.keyboard_modifiers),!0):a.type==SPICE_MSG_INPUTS_KEY_MODIFIERS?(c=new SpiceMsgInputsKeyModifiers(a.data),this.keyboard_modifiers=c.keyboard_modifiers,DEBUG>1&&console.log("MsgInputsKeyModifiers - modifier "+this.keyboard_modifiers),!0):a.type==SPICE_MSG_INPUTS_MOUSE_MOTION_ACK?(DEBUG>1&&console.log("mouse motion ack"),this.waiting_for_ack-=SPICE_INPUT_MOTION_ACK_BUNCH,!0):(this.log_warn("unhandle msg.type :"+a.type+" in Inputs Channel."),!1)};