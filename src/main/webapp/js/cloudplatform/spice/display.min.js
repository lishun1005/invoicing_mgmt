"use strict";function putImageDataWithAlpha(a,b,c,d,e,f,g,h){var i,j;e=void 0==e?b.width:e,f=void 0==f?b.height:f,void 0==g&&void 0==h&&(g=0,h=0),i=document.createElement("canvas"),j=i.getContext("2d"),i.setAttribute("width",b.width),i.setAttribute("height",b.height),j.putImageData(b,0,0),a.drawImage(i,g,h,e,f,c,d,e,f)}function drawImgToCanvas(a,b,c,d){var e=b.width,f=b.height,g=1,h=1,i=Math.PI;h*=-1,a.save(),a.clearRect(c,d,e,f),a.translate(c+e/2,d+f/2),a.rotate(i),a.scale(h,g),a.drawImage(b,-e/2,-f/2),a.restore()}function putDebugImg(a,b,c,d,e){var f=document.createElement("canvas"),g=f.getContext("2d");f.setAttribute("width",d),f.setAttribute("height",e),g.putImageData(a,0,0,b,c,d,e),document.getElementById("debug-div").appendChild(f)}function stripAlpha(a,b){var c,d;for(c=b?b:255,d=0;d<4*a.width*a.height;d+=4)a.data[d+3]=c}function SpiceDisplayConn(){SpiceConn.apply(this,arguments)}function handle_mouseover(){var b=document.getElementById(this.sc.screen_id);b.style.cursor="default",this.focus()}function handle_mouseout(){this.sc&&this.sc.cursor&&this.sc.cursor.spice_simulated_cursor&&(this.sc.cursor.spice_simulated_cursor.style.display="none"),this.blur()}function handle_draw_jpeg_onload(){var b,c,d,e,f,g,h,a=null;if(this.o.sc.surfaces){if(void 0===this.o.sc.surfaces[this.o.base.surface_id]?(DEBUG>2&&this.o.sc.log_info("Discarding jpeg; presumed lost surface "+this.o.base.surface_id),a=document.createElement("canvas"),a.setAttribute("width",this.o.base.box.right),a.setAttribute("height",this.o.base.box.bottom),b=a.getContext("2d")):b=this.o.sc.surfaces[this.o.base.surface_id].canvas.context,c=document.createElement("canvas"),d=c.getContext("2d"),this.alpha_img)c.setAttribute("width",this.alpha_img.width),c.setAttribute("height",this.alpha_img.height),d.putImageData(this.alpha_img,0,0),d.globalCompositeOperation="source-in",d.drawImage(this,0,0),b.drawImage(c,this.o.base.box.left,this.o.base.box.top),this.o.descriptor&&this.o.descriptor.flags&SPICE_IMAGE_FLAGS_CACHE_ME&&("cache"in this.o.sc||(this.o.sc.cache={}),this.o.sc.cache[this.o.descriptor.id]=d.getImageData(0,0,this.alpha_img.width,this.alpha_img.height));else{if(c.setAttribute("width",this.width),c.setAttribute("height",this.height),this.o.top_down?d.drawImage(this,0,0):drawImgToCanvas(d,this,0,0),this.o.stream&&(this.o.base.box=this.o.stream.dest,this.o.base.clip=this.o.stream.clip),1==this.o.base.clip.type&&this.o.base.clip.rects.num_rects>0)for(console.log("SPICE_MSG_DISPLAY_STREAM_DATA can not handle clip yet."),handle_clip(this.o.base.box,this.o.base.clip.rects),e=this.o.base.clip.rects.rects,f=0;f<this.o.base.clip.rects.num_rects;f++)null!=e[f]&&(g=e[f].right-e[f].left,h=e[f].bottom-e[f].top,b.drawImage(c,e[f].margin_left,e[f].margin_top,g,h,e[f].left,e[f].top,g,h));else b.drawImage(c,this.o.base.box.left,this.o.base.box.top);this.src=null,this.o.descriptor&&this.o.descriptor.flags&SPICE_IMAGE_FLAGS_CACHE_ME&&("cache"in this.o.sc||(this.o.sc.cache={}),this.o.sc.cache[this.o.descriptor.id]=d.getImageData(0,0,this.width,this.height))}null==a&&(DUMP_DRAWS&&this.o.sc.parent.dump_id&&(c.setAttribute("id",this.o.tag+"."+this.o.sc.surfaces[this.o.base.surface_id].draw_count+"."+this.o.base.surface_id+"@"+this.o.base.box.left+"x"+this.o.base.box.top),document.getElementById(this.o.sc.parent.dump_id).appendChild(c)),this.o.sc.surfaces[this.o.base.surface_id].draw_count++)}}function handle_rop(a,b,c,d,e,f){var g,h,i;switch(e||(g=c.right-c.left,h=c.bottom-c.top),a){case SPICE_ROPD_OP_PUT:break;case SPICE_ROPD_OP_OR:if(!d){console.log("FIXME-2: src_image is null in SPICE_ROPD_OP_OR ");break}for(e||(e=b.getImageData(c.left,c.top,d.width,d.height)),i=0;i<e.data.length;i+=4)e.data[i]=e.data[i]|d.data[i],e.data[i+1]=e.data[i+1]|d.data[i+1],e.data[i+2]=e.data[i+2]|d.data[i+2],f&&(e.data[i+3]=e.data[i+3]|d.data[i+3]);break;case SPICE_ROPD_OP_AND:if(!d){console.log("FIXME-2: src_image is null in SPICE_ROPD_OP_AND ");break}for(e||(e=b.getImageData(c.left,c.top,d.width,d.height)),i=0;i<e.data.length;i+=4)e.data[i]=e.data[i]&d.data[i],e.data[i+1]=e.data[i+1]&d.data[i+1],e.data[i+2]=e.data[i+2]&d.data[i+2],f&&(e.data[i+3]=e.data[i+3]&d.data[i+3]);break;case SPICE_ROPD_OP_XOR:if(!d){console.log("FIXME-2: src_image is null in SPICE_ROPD_OP_XOR ");break}for(e||(e=b.getImageData(c.left,c.top,d.width,d.height)),i=0;i<e.data.length;i+=4)e.data[i]=e.data[i]^d.data[i],e.data[i+1]=e.data[i+1]^d.data[i+1],e.data[i+2]=e.data[i+2]^d.data[i+2],f&&(e.data[i+3]=e.data[i+3]^d.data[i+3]);break;case SPICE_ROPD_OP_BLACKNESS:for(e||(e=b.createImageData(g,h)),i=0;i<e.data.length;i+=4)e.data[i]=0,e.data[i+1]=0,e.data[i+2]=0,f&&(e.data[i+3]=0);break;case SPICE_ROPD_OP_WHITENESS:for(e||(e=b.createImageData(g,h)),i=0;i<e.data.length;i+=4)e.data[i]=255,e.data[i+1]=255,e.data[i+2]=255,f&&(e.data[i+3]=255);break;case SPICE_ROPD_OP_INVERS:console.log("FIXME-2: SPICE_ROPD_OP_INVERS is unhandle now ");break;case SPICE_ROPD_INVERS_RES:console.log("FIXME-2: SPICE_ROPD_INVERS_RES is unhandle now ");break;case SPICE_ROPD_INVERS_SRC:console.log("FIXME-2: SPICE_ROPD_INVERS_SRC is unhandle now ");break;case SPICE_ROPD_INVERS_BRUSH:console.log("FIXME-2: SPICE_ROPD_INVERS_BRUSH is unhandle now ");break;case SPICE_ROPD_INVERS_DEST:console.log("FIXME-2: SPICE_ROPD_INVERS_DEST is unhandle now ");break;default:console.log("FIXME-2: unknow SPICE_ROPD type :"+a)}return null!=e?e:d}function handle_clip(a,b){var c,d,e,f;if(!a||!b)return!1;for(c=b.num_rects,b=b.rects,d=0;c>d;d++)null!=b[d]&&(e=0,f=0,b[d].left<a.right?(b[d].left<=a.left?b[d].left=a.left:e=b[d].left-a.left,b[d].top<a.bottom?(b[d].top<=a.top?b[d].top=a.top:f=b[d].top-a.top,b[d].right>a.left?(b[d].right>a.right&&(b[d].right=a.right),b[d].bottom>a.top?(b[d].bottom>a.bottom&&(b[d].bottom=a.bottom),b[d].right-b[d].left<=0||b[d].bottom-b[d].top<=0?b[d]=null:(b[d].margin_left=e,b[d].margin_top=f)):b[d]=null):b[d]=null):b[d]=null):b[d]=null);return!0}function canvas_get_bitmap_mask(a,b,c){var m,n,o,p,d=new Uint8Array(b.data),e=a.createImageData(b.x,b.y),f=0,g=b.stride,h=f+b.y*g,j=SPICE_ALIGN(b.x,8)>>3,k=b.x,l=0;if(b.flags&SPICE_BITMAP_FLAGS_TOP_DOWN||(l+=k*(b.y-1),k=-k),c)switch(b.format){case SPICE_BITMAP_FMT_1BIT_BE:for(;f!=h;f+=g,l+=k)for(m=l,n=f,o=n+j;o>n;)for(p=~d[n++],i=7;i>=0;i--)e.data[4*m+3]=1&p>>i?0:255,m++;break;case SPICE_BITMAP_FMT_1BIT_LE:for(;f!=h;f+=g,l+=k)for(m=l,n=f,o=n+j;o>n;)for(p=~revers_bits(d[n++]),i=7;i>=0;i--)e.data[4*m+3]=1&p>>i?0:255,m++}else switch(b.format){case SPICE_BITMAP_FMT_1BIT_BE:for(;f!=h;f+=g,l+=k)for(m=l,n=f,o=n+j;o>n;)for(p=d[n++],i=7;i>=0;i--)e.data[4*m+3]=1&p>>i?0:255,m++;break;case SPICE_BITMAP_FMT_1BIT_LE:for(;f!=h;f+=g,l+=k)for(m=l,n=f,o=n+j;o>n;)for(p=revers_bits(d[n++]),i=7;i>=0;i--)e.data[4*m+3]=1&p>>i?0:255,m++}return e}function copy_bitmap_alpha(a,b,c,d,e,f,g){var i,n,o,p,h=0,j=0,k=0,l=0,m=0;for(i=1==g?1:8;b>h;){for(n=0;c>n;++n)o=a[m+k],o>>=j*i,o&=255>>8-i,o=255*o/(255>>8-i),e[l+4*n+3]=o,p=o/255,e[l+4*n+2]=p*e[l+4*n+2],e[l+4*n+1]=p*e[l+4*n+1],e[l+4*n]=p*e[l+4*n],j++,j==8/i&&(k++,j=0);l+=4*c,k=0,m+=d,j=0,h++}return e}function canvas_get_str_mask(a,b,c,d){var e,f,g,h,j,k;if(b.length<=0)return!1;for(e={},f=b.glyphs[0],canvas_raster_glyph_box(f,e),i=1;i<b.length;i++)g={},canvas_raster_glyph_box(b.glyphs[i],g),rect_union(e,g);switch(h=a.createImageData(e.right-e.left,e.bottom-e.top),j=0,k=e.right-e.left,c){case 1:k/=8,k=Math.ceil(k),k+=3,k=-4&k;break;case 4:k+=3,k=-4&k;break;case 32:k=4*k;break;default:return console.log("unable to canvas_get_str_mask"),void 0}for(i=0;i<b.length;i++)f=b.glyphs[i],canvas_put_glyph_bits(f,c,j,k,e,h.data);return d.x=e.left,d.y=e.top,h}function canvas_put_glyph_bits(a,b,c,d,e,f){var h,i,j,k,l,m,n,o,g={};if(canvas_raster_glyph_box(a,g),!(g.top>=e.top&&g.bottom<=e.bottom))return!1;if(!(g.left>=e.left&&g.right<=e.right))return!1;switch(rect_offset(g,-e.left,-e.top),c+=g.top*d,h=new Uint8Array(a.data),i=0,j=g.bottom-g.top,k=g.right-g.left,b){case 1:for(l=SPICE_ALIGN(k,8)>>3,i+=l*j,m=0;j>m;m++)i-=l,canvas_put_bits(c,g.left,i,k,h,f),c+=d;break;case 4:for(l=SPICE_ALIGN(4*k,8)>>3,i+=l*j,c+=g.left,n=c+d*j;c!=n;c+=d){for(m=0,i-=l,o=i;(-2&k)>m;)f[c+m]=MAX(f[c+m],240&h[o]),f[c+m+1]=MAX(f[c+m+1],240&h[o]<<4),m+=2,o++;k>m&&(f[c+m]=MAX(f[c+m],240&h[o]),o++)}break;case 8:default:return this.log_warn("FIXME-2:unknow bpp in canvas_get_str_mask"),void 0}}function canvas_put_bits(a,b,c,d,e,f){for(;d;){var g=MIN(d,8);d-=g,__canvas_put_bits(a,b,e[c],g,e,f),b+=g,c++}}function __canvas_put_bits(a,b,c,d,e,f){var g,h;a+=b>>3,b&=7,h=MIN(8-b,d),g=(1<<h)-1,g<<=b,c=revers_bits(c),f[a]=c<<b&g|f[a],(d-=h)&&(g=(1<<d)-1,a++,f[a]=c>>h&g|f[a])}function revers_bits(a){var c,d,b=0;for(c=0;4>c;c++)d=7-2*c,b|=(a&1<<c)<<d,b|=(a&128>>c)>>d;return b}function SPICE_ALIGN(a,b){return a+(b-1)&~(b-1)}function canvas_raster_glyph_box(a,b){b&&(b.top=a.render_pos.y+a.glyph_origin.y,b.bottom=b.top+a.height,b.left=a.render_pos.x+a.glyph_origin.x,b.right=b.left+a.width)}function rect_area(a,b,c){c?(c.top=MAX(a.top,b.top),c.left=MAX(a.left,b.left),c.bottom=MIN(a.bottom,b.bottom),c.right=MIN(a.right,b.right)):(a.top=MAX(a.top,b.top),a.left=MAX(a.left,b.left),a.bottom=MIN(a.bottom,b.bottom),a.right=MIN(a.right,b.right))}function rect_union(a,b){a.top=MIN(a.top,b.top),a.left=MIN(a.left,b.left),a.bottom=MAX(a.bottom,b.bottom),a.right=MAX(a.right,b.right)}function rect_offset(a,b,c){a.left+=b,a.right+=b,a.top+=c,a.bottom+=c}function MIN(a,b){return a>b?b:a}function MAX(a,b){return b>a?b:a}function fix_to_double(a){return(15&a)/15+(a>>4)}function line_to(a,b,c,d,e){return a?(b==d&&(b+=.5,d+=.5),c==e&&(c+=.5,e+=.5),a.moveTo(b,c),a.lineTo(d,e),void 0):!1}SpiceDisplayConn.prototype=Object.create(SpiceConn.prototype),SpiceDisplayConn.prototype.process_channel_message=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V;if(a.type==SPICE_MSG_DISPLAY_MARK)return this.known_unimplemented(a.type,"Display Mark"),!0;if(a.type==SPICE_MSG_DISPLAY_RESET)return DEBUG>2&&console.log("Display reset"),this.surfaces[this.primary_surface].canvas.context.restore(),!0;if(a.type==SPICE_MSG_DISPLAY_DRAW_COPY)return b=new SpiceMsgDisplayDrawCopy(a.data),DEBUG>=1&&this.log_draw("DrawCopy",b),this.handle_src_bitmap(a.type,b);if(a.type==SPICE_MSG_DISPLAY_DRAW_BLEND)return b=new SpiceMsgDisplayDrawCopy(a.data),DEBUG>=1&&this.log_draw("DrawBlend",b),this.handle_src_bitmap(a.type,b);if(a.type==SPICE_MSG_DISPLAY_DRAW_FILL){if(c=new SpiceMsgDisplayDrawFill(a.data),DEBUG>=1&&this.log_draw("DrawFill",c),c.data.rop_descriptor!=SPICE_ROPD_OP_PUT&&c.data.rop_descriptor!=SPICE_ROPD_OP_XOR&&1088!=c.data.rop_descriptor&&this.log_warn("FIXME: DrawFill we don't handle ropd type: "+c.data.rop_descriptor),c.data.mask.bitmap&&this.log_warn("FIXME: DrawFill we don't handle mask"),(1088==c.data.rop_descriptor||c.data.rop_descriptor==SPICE_ROPD_OP_XOR)&&1==c.data.brush.type){if(d=c.base.box.right-c.base.box.left,e=c.base.box.bottom-c.base.box.top,f=this.surfaces[c.base.surface_id].canvas,!f)return!1;for(g=f.context.getImageData(c.base.box.left,c.base.box.top,d,e),h=0;h<g.data.length;h+=4)g.data[h]=255-g.data[h],g.data[h+1]=255-g.data[h+1],g.data[h+2]=255-g.data[h+2],g.data[h+3]=255;return f.context.putImageData(g,c.base.box.left,c.base.box.top),!0}return this.handle_brush({base:c.base,bush:c.data.brush,rop:c.data.rop_descriptor})}if(a.type==SPICE_MSG_DISPLAY_DRAW_ALPHA_BLEND)return i=new SpiceMsgDisplayDrawAlphaBlend(a.data),DEBUG>=1&&this.log_draw("DrawAlphaBlend",i),i.data.src_bitmap?this.handle_src_bitmap(a.type,i):!0;if(a.type==SPICE_MSG_DISPLAY_DRAW_TEXT){if(j=new SpiceMsgDisplayDrawText(a.data),DEBUG>=1&&this.log_draw("DrawText",j),k=j.data.back_area,k.top!=k.bottom&&k.left!=k.right){if(j.data.fore_mode!=SPICE_ROPD_OP_PUT)return!1;this.handle_brush({base:j.base,bush:j.data.back_brush})}if(j.data.str.flags&SPICE_STRING_FLAGS_RASTER_A1)l=1,m=this.draw_str_mask_bitmap({base:j.base,str:j.data.str,bpp:l,fore_brush:j.data.fore_brush});else if(j.data.str.flags&SPICE_STRING_FLAGS_RASTER_A4)l=4,m=this.draw_str_mask_bitmap({base:j.base,str:j.data.str,bpp:l,fore_brush:j.data.fore_brush});else{if(!(j.data.str.flags&SPICE_STRING_FLAGS_RASTER_A8))return this.log_warn("FIXME: unsupported path vector glyphs"),!1;this.log_warn("FIXME-2: unsupported SPICE_STRING_FLAGS_RASTER_A8 yet."),l=8}return m}if(a.type==SPICE_MSG_DISPLAY_DRAW_STROKE){if(n=new SpiceMsgDisplayDrawStroke(a.data),DEBUG>=1&&this.log_draw("DrawStroke",n),void 0==this.surfaces[n.base.surface_id])return!1;if(o=this.surfaces[n.base.surface_id].canvas,p=o.context,n.data.fore_mode!=SPICE_ROPD_OP_PUT&&this.log_warn("FIXME-2: SPICE_MSG_DISPLAY_DRAW_STROKE is not handle (fore_mode != SPICE_ROPD_OP_PUT) yet."),n.base.clip.type!=SPICE_CLIP_TYPE_NONE){for(p.save(),q=n.base.clip.rects,h=0;h<q.num_rects;h++)p.rect(q.rects[h].left,q.rects[h].top,q.rects[h].right-q.rects[h].left,q.rects[h].bottom-q.rects[h].top);p.clip()}for(n.data.brush.type==SPICE_BRUSH_TYPE_SOLID?(r=16777215&n.data.brush.color,s="rgb("+(r>>16)+", "+(255&r>>8)+", "+(255&r)+")",p.strokeStyle=s):n.data.brush.type==SPICE_BRUSH_TYPE_PATTERN&&(this.log_warn("FIXME-2: SPICE_MSG_DISPLAY_DRAW_STROKE is not handle SPICE_BRUSH_TYPE_PATTERN yet."),p.fillStyle="rgb(0,0,0)"),h=0;h<n.data.path.num_segments;h++){if(t=n.data.path.segments[h],u=0,t.flags&SPICE_PATH_BEGIN&&(p.beginPath(),u++),t.flags&SPICE_PATH_BEZIER)this.log_warn("FIXME-2: SPICE_MSG_DISPLAY_DRAW_STROKE is not handle SPICE_PATH_BEZIER yet.");else for(;u<t.count;u++)v=fix_to_double(t.points[u].x),w=fix_to_double(t.points[u].y),line_to(p,fix_to_double(t.points[u-1].x),fix_to_double(t.points[u-1].y),v,w);t.flags&SPICE_PATH_END&&(t.flags&SPICE_PATH_CLOSE&&(v=fix_to_double(t.points[t.count-1].x),w=fix_to_double(t.points[t.count-1].y),line_to(p,v,w,fix_to_double(t.points[0].x),fix_to_double(t.points[0].y))),p.stroke())}return n.base.clip.type!=SPICE_CLIP_TYPE_NONE&&p.restore(),!0}if(a.type==SPICE_MSG_DISPLAY_DRAW_ROP3)return x=new SpiceMsgDisplayDrawRop3(a.data),DEBUG>=1&&this.log_draw("DrawRop3",x),this.handle_src_bitmap(a.type,x);if(a.type==SPICE_MSG_DISPLAY_DRAW_TRANSPARENT)return y=new SpiceMsgDisplayDrawTransparent(a.data),DEBUG>=1&&this.log_draw("DrawTransparent",y),y.data.src_bitmap?this.handle_src_bitmap(a.type,y):!1;if(a.type==SPICE_MSG_DISPLAY_DRAW_BLACKNESS)return z=new SpiceMsgDisplayDrawBlackness(a.data),DEBUG>=1&&this.log_draw("SPICE_MSG_DISPLAY_DRAW_BLACKNESS",z),void 0==this.surfaces[z.base.surface_id]?!1:z.data.mask.bitmap?(this.log_warn("FIXME: SPICE_MSG_DISPLAY_DRAW_BLACKNESS we don't handle mask"),!1):(o=this.surfaces[z.base.surface_id].canvas,p=o.context,p.fillStyle="rgb(0,0,0)",p.fillRect(z.base.box.left,z.base.box.top,z.base.box.right-z.base.box.left,z.base.box.bottom-z.base.box.top),!0);if(a.type==SPICE_MSG_DISPLAY_DRAW_WHITENESS)return A=new SpiceMsgDisplayDrawWhiteness(a.data),DEBUG>=1&&this.log_draw("SPICE_MSG_DISPLAY_DRAW_WHITENESS",A),void 0==this.surfaces[A.base.surface_id]?!1:A.data.mask.bitmap?(this.log_warn("FIXME: SPICE_MSG_DISPLAY_DRAW_WHITENESS we don't handle mask"),!1):(o=this.surfaces[A.base.surface_id].canvas,p=o.context,p.fillStyle="rgb(255,255,255)",p.fillRect(A.base.box.left,A.base.box.top,A.base.box.right-A.base.box.left,A.base.box.bottom-A.base.box.top),!0);if(a.type==SPICE_MSG_DISPLAY_DRAW_INVERS){if(B=new SpiceMsgDisplayDrawInvers(a.data),DEBUG>=1&&this.log_draw("DrawInvers",B),void 0==this.surfaces[B.base.surface_id])return!1;if(o=this.surfaces[B.base.surface_id].canvas,p=o.context,C=B.base.box.left,D=B.base.box.top,B.base.clip.type!=SPICE_CLIP_TYPE_NONE){for(handle_clip(B.base.box,B.base.clip.rects),h=0;h<B.base.clip.rects.num_rects;h++)if(null!=B.base.clip.rects.rects[h]){for(E=B.base.clip.rects.rects[h].right-B.base.clip.rects.rects[h].left,F=B.base.clip.rects.rects[h].bottom-B.base.clip.rects.rects[h].top,G=B.base.clip.rects.rects[h].margin_left,H=B.base.clip.rects.rects[h].margin_top,I=p.getImageData(C+G,D+H,E,F),J=0;J<I.data.length;J+=4)I.data[J]=255-I.data[J],I.data[J+1]=255-I.data[J+1],I.data[J+2]=255-I.data[J+2],I.data[J+3]=255;p.putImageData(I,C+G,D+H)}}else{for(I=p.getImageData(C,D,B.base.box.right-C,B.base.box.bottom-D),h=0;h<I.data.length;h+=4)I.data[h]=255-I.data[h],I.data[h+1]=255-I.data[h+1],I.data[h+2]=255-I.data[h+2],I.data[h+3]=255;p.putImageData(I,C,D)}return!0}if(a.type==SPICE_MSG_DISPLAY_COPY_BITS){if(K=new SpiceMsgDisplayCopyBits(a.data),DEBUG>=1&&this.log_draw("CopyBits",K),o=this.surfaces[K.base.surface_id].canvas,L=o.context,M=o.width-K.src_pos.x,N=o.height-K.src_pos.y,M>K.base.box.right-K.base.box.left&&(M=K.base.box.right-K.base.box.left),N>K.base.box.bottom-K.base.box.top&&(N=K.base.box.bottom-K.base.box.top),O=L.getImageData(K.src_pos.x,K.src_pos.y,M,N),P=document.createElement("canvas"),P.setAttribute("width",M),P.setAttribute("height",N),P.getContext("2d").putImageData(O,0,0),K.base.clip&&K.base.clip.type!=SPICE_CLIP_TYPE_NONE)for(handle_clip(K.base.box,K.base.clip.rects),q=K.base.clip.rects.rects,h=0;h<K.base.clip.rects.num_rects;h++)null!=q[h]&&(Q=q[h].right-q[h].left,R=q[h].bottom-q[h].top,L.drawImage(P,q[h].left-K.base.box.left,q[h].top-K.base.box.top,Q,R,q[h].left,q[h].top,Q,R));else L.drawImage(P,K.base.box.left,K.base.box.top);return DUMP_DRAWS&&this.parent.dump_id&&(P.setAttribute("id","copybits"+K.base.surface_id+"."+this.surfaces[K.base.surface_id].draw_count),document.getElementById(this.parent.dump_id).appendChild(P)),this.surfaces[K.base.surface_id].draw_count++,!0}if(a.type==SPICE_MSG_DISPLAY_INVAL_ALL_PALETTES)return palette_cache={},!0;if(a.type==SPICE_MSG_DISPLAY_SURFACE_CREATE)return"surfaces"in this||(this.surfaces=[]),S=new SpiceMsgSurfaceCreate(a.data),DEBUG>0&&this.log_info(this.type+": MsgSurfaceCreate id "+S.surface.surface_id+"; "+S.surface.width+"x"+S.surface.height+"; format "+S.surface.format+"; flags "+S.surface.flags),S.surface.format!=SPICE_SURFACE_FMT_32_xRGB&&S.surface.format!=SPICE_SURFACE_FMT_32_ARGB?(this.log_warn("FIXME: cannot handle surface format "+S.surface.format+" yet."),!1):(f=document.createElement("canvas"),f.setAttribute("width",S.surface.width),f.setAttribute("height",S.surface.height),f.setAttribute("id","spice_surface_"+S.surface.surface_id),f.setAttribute("tabindex",S.surface.surface_id),f.context=f.getContext("2d"),DUMP_CANVASES&&this.parent.dump_id&&document.getElementById(this.parent.dump_id).appendChild(f),S.surface.canvas=f,S.surface.draw_count=0,this.surfaces[S.surface.surface_id]=S.surface,S.surface.flags&SPICE_SURFACE_FLAGS_PRIMARY&&(this.primary_surface=S.surface.surface_id,f.context.save(),document.getElementById(this.parent.screen_id).appendChild(f),document.getElementById(this.parent.screen_id).setAttribute("width",S.surface.width),document.getElementById(this.parent.screen_id).setAttribute("height",S.surface.height),this.hook_events()),0==S.surface.surface_id&&(1!=this.parent.main_init.current_mouse_mode||this.parent.main_init.agent_connected||(window.moveTo(0,0),window.resizeTo(S.surface.width+17,S.surface.height+69))),!0);if(a.type==SPICE_MSG_DISPLAY_SURFACE_DESTROY)return S=new SpiceMsgSurfaceDestroy(a.data),DEBUG>=1&&console.log(this.type+": MsgSurfaceDestroy id "+S.surface_id),this.delete_surface(S.surface_id),!0;if(a.type==SPICE_MSG_DISPLAY_STREAM_CREATE)return S=new SpiceMsgDisplayStreamCreate(a.data),DEBUG>=1&&console.log(this.type+": MsgStreamCreate id"+S.id),this.streams||(this.streams=new Array),this.streams[S.id]&&console.log("Stream already exists"),this.streams[S.id]=S,S.codec_type!=SPICE_VIDEO_CODEC_TYPE_MJPEG&&console.log("Unhandled stream codec: "+S.codec_type),!0;if(a.type==SPICE_MSG_DISPLAY_STREAM_DATA){if(S=new SpiceMsgDisplayStreamData(a.data),!this.streams[S.base.id])return console.log("no stream for data"),!1;if(this.streams[S.base.id].codec_type===SPICE_VIDEO_CODEC_TYPE_MJPEG){for(T="data:image/jpeg,",U=new Image,h=0;h<S.data.length;h++)T+="%",S.data[h]<16&&(T+="0"),T+=S.data[h].toString(16);V=new SpiceMsgDisplayBase,V.surface_id=this.streams[S.base.id].surface_id,V.box=this.streams[S.base.id].dest,V.clip=this.streams[S.base.id].clip,U.o={base:V,tag:"mjpeg."+S.base.id,descriptor:null,sc:this,top_down:this.streams[S.base.id].flags,stream:this.streams[S.base.id]},U.onload=handle_draw_jpeg_onload,U.src=T}return!0}if(a.type==SPICE_MSG_DISPLAY_STREAM_CLIP)return S=new SpiceMsgDisplayStreamClip(a.data),DEBUG>=1&&console.log(this.type+": MsgStreamClip id"+S.id),this.streams[S.id].clip=S.clip,!0;if(a.type==SPICE_MSG_DISPLAY_STREAM_DESTROY){for(S=new SpiceMsgDisplayStreamDestroy(a.data),DEBUG>1&&console.log(this.type+": MsgStreamDestroy id"+S.id),h=0;h<S.count;h++)void 0!=this.streams[S.resources[h].id]&&delete this.streams[S.resources[h].id];return!0}if(a.type==SPICE_MSG_DISPLAY_STREAM_DESTROY_ALL)return DEBUG>1&&console.log("get SPICE_MSG_DISPLAY_STREAM_DESTROY_ALL message ."),this.streams={},!0;if(a.type==SPICE_MSG_DISPLAY_INVAL_LIST){for(S=new SpiceMsgDisplayInvalList(a.data),DEBUG>1&&console.log(this.type+": MsgInvalList "+S.count+" items"),h=0;h<S.count;h++)void 0!=this.cache[S.resources[h].id]&&delete this.cache[S.resources[h].id];return!0}return this.log_warn("unhandle msg.type :"+a.type+" in display Channel."),!1},SpiceDisplayConn.prototype.delete_surface=function(a){document.getElementById("spice_surface_"+a),DUMP_CANVASES&&this.parent.dump_id&&(document.getElementById(this.parent.dump_id).innerHTML=""),this.primary_surface==a&&(this.unhook_events(),this.primary_surface=void 0,document.getElementById(this.parent.screen_id).innerHTML=""),delete this.surfaces[a]},SpiceDisplayConn.prototype.log_draw=function(a,b){var c,d,e,f;if(this.surfaces[b.base.surface_id]?c=a+"."+b.base.surface_id+"."+this.surfaces[b.base.surface_id].draw_count+": ":(console.log("WARNING : surface_id:"+b.base.surface_id+" is undefined !"),c=a+"."+b.base.surface_id+"."+"draw_count_undefined"+": "),c+="base.box "+b.base.box.left+", "+b.base.box.top+" to "+b.base.box.right+", "+b.base.box.bottom,c+="; clip.type "+b.base.clip.type,b.base.clip.type!=SPICE_CLIP_TYPE_NONE)for(d=b.base.clip.rects.num_rects,e=b.base.clip.rects.rects,f=0;d>f;f++)c+="; clip: "+f+" "+e[f].left+", "+e[f].top+" to "+e[f].right+", "+e[f].bottom;b.data&&(b.data.alpha&&(c+="; alpha "+b.data.alpha+", alpha_flags "+b.data.alpha_flags),b.data.src_area&&(c+="; src_area "+b.data.src_area.left+", "+b.data.src_area.top+" to "+b.data.src_area.right+", "+b.data.src_area.bottom),b.data.src_bitmap&&null!=b.data.src_bitmap?(c+="; src_bitmap id: "+b.data.src_bitmap.descriptor.id,c+="; src_bitmap width "+b.data.src_bitmap.descriptor.width+", height "+b.data.src_bitmap.descriptor.height,c+="; src_bitmap type "+b.data.src_bitmap.descriptor.type+", flags "+b.data.src_bitmap.descriptor.flags,void 0!==b.data.src_bitmap.surface_id&&(c+="; src_bitmap surface_id "+b.data.src_bitmap.surface_id),b.data.src_bitmap.quic&&(c+="; QUIC type "+b.data.src_bitmap.quic.type+"; width "+b.data.src_bitmap.quic.width+"; height "+b.data.src_bitmap.quic.height),b.data.src_bitmap.lz_rgb&&(c+="; LZ_RGB length "+b.data.src_bitmap.lz_rgb.length+"; magic "+b.data.src_bitmap.lz_rgb.magic+"; version 0x"+b.data.src_bitmap.lz_rgb.version.toString(16)+"; type "+b.data.src_bitmap.lz_rgb.type+"; width "+b.data.src_bitmap.lz_rgb.width+"; height "+b.data.src_bitmap.lz_rgb.height+"; stride "+b.data.src_bitmap.lz_rgb.stride+"; top down "+b.data.src_bitmap.lz_rgb.top_down)):c+="; src_bitmap is null",b.data.brush&&(b.data.brush.type==SPICE_BRUSH_TYPE_SOLID&&(c+="; brush.color 0x"+b.data.brush.color.toString(16)),b.data.brush.type==SPICE_BRUSH_TYPE_PATTERN&&(c+="; brush.pat ",null!=b.data.brush.pattern.pat?(c+="[SpiceImage:"+b.data.brush.pattern.pat.descriptor.id+"]",null!=b.data.brush.pattern.pat.bitmap&&(c+="; brush.pat.bitmap x "+b.data.brush.pattern.pat.bitmap.x+", y "+b.data.brush.pattern.pat.bitmap.y)):c+="[null]",c+=" at "+b.data.brush.pattern.pos.x+", "+b.data.brush.pattern.pos.y)),c+="; rop_descriptor "+b.data.rop_descriptor,void 0!==b.data.scale_mode&&(c+="; scale_mode "+b.data.scale_mode),b.data.mask&&(c+="; mask.flags "+b.data.mask.flags,c+="; mask.pos "+b.data.mask.pos.x+", "+b.data.mask.pos.y,null!=b.data.mask.bitmap?(c+="; mask.bitmap width "+b.data.mask.bitmap.descriptor.width+", height "+b.data.mask.bitmap.descriptor.height,c+="; mask.bitmap type "+b.data.mask.bitmap.descriptor.type+", flags "+b.data.mask.bitmap.descriptor.flags):c+="; mask.bitmap is null")),console.log(c)},SpiceDisplayConn.prototype.hook_events=function(){if(void 0!==this.primary_surface){var a=this.surfaces[this.primary_surface].canvas;a.sc=this.parent,a.addEventListener("mousemove",handle_mousemove),a.addEventListener("mousedown",handle_mousedown),a.addEventListener("contextmenu",handle_contextmenu),a.addEventListener("mouseup",handle_mouseup),a.addEventListener("keydown",handle_keydown),a.addEventListener("keyup",handle_keyup),a.addEventListener("mouseout",handle_mouseout),a.addEventListener("mouseover",handle_mouseover),a.addEventListener("DOMMouseScroll",handle_mousewheel),a.addEventListener("mousewheel",handle_mousewheel),a.focus()}},SpiceDisplayConn.prototype.unhook_events=function(){if(void 0!==this.primary_surface){var a=this.surfaces[this.primary_surface].canvas;a.removeEventListener("mousemove",handle_mousemove),a.removeEventListener("mousedown",handle_mousedown),a.removeEventListener("contextmenu",handle_contextmenu),a.removeEventListener("mouseup",handle_mouseup),a.removeEventListener("keydown",handle_keydown),a.removeEventListener("keyup",handle_keyup),a.removeEventListener("mouseout",handle_mouseout),a.removeEventListener("mouseover",handle_mouseover),a.removeEventListener("DOMMouseScroll",handle_mousewheel),a.removeEventListener("mousewheel",handle_mousewheel)}},SpiceDisplayConn.prototype.destroy_surfaces=function(){for(var a in this.surfaces)this.delete_surface(this.surfaces[a].surface_id);this.surfaces=void 0},SpiceDisplayConn.prototype.handle_draw_jpeg=function(a){var c,d,e,f,g,h,i,b=null;if(a.sc.surfaces)if(void 0===a.sc.surfaces[a.base.surface_id]?(DEBUG>2&&a.sc.log_info("Discarding jpeg; presumed lost surface "+a.base.surface_id),b=document.createElement("canvas"),b.setAttribute("width",a.base.box.right),b.setAttribute("height",a.base.box.bottom),c=b.getContext("2d")):c=a.sc.surfaces[a.base.surface_id].canvas.context,d=document.createElement("canvas"),e=d.getContext("2d"),a.img.alpha_img)d.setAttribute("width",a.img.alpha_img.width),d.setAttribute("height",a.img.alpha_img.height),e.putImageData(a.img.alpha_img,0,0),e.globalCompositeOperation="source-in",e.drawImage(a.img,0,0),c.drawImage(d,a.base.box.left,a.base.box.top),a.descriptor&&a.descriptor.flags&SPICE_IMAGE_FLAGS_CACHE_ME&&("cache"in a.sc||(a.sc.cache={}),a.sc.cache[a.descriptor.id]=e.getImageData(0,0,a.img.alpha_img.width,a.img.alpha_img.height));else{if(d.setAttribute("width",a.img.width),d.setAttribute("height",a.img.height),a.top_down?drawImgToCanvas(e,a.img,0,0):e.drawImage(a.img,0,0),a.base.clip.type!=SPICE_CLIP_TYPE_NONE)for(handle_clip(a.base.box,a.base.clip.rects),f=a.base.clip.rects.rects,g=0;g<a.base.clip.rects.num_rects;g++)null!=f[g]&&(h=f[g].right-f[g].left,i=f[g].bottom-f[g].top,c.drawImage(d,f[g].left-a.base.box.left,f[g].top-a.base.box.top,h,i,f[g].left,f[g].top,h,i));else c.drawImage(d,a.base.box.left,a.base.box.top);a.descriptor&&a.descriptor.flags&SPICE_IMAGE_FLAGS_CACHE_ME&&("cache"in a.sc||(a.sc.cache={}),a.sc.cache[a.descriptor.id]=e.getImageData(0,0,a.img.width,a.img.height)),null==b&&(DUMP_DRAWS&&a.sc.parent.dump_id&&(d.setAttribute("id",a.tag+"."+a.sc.surfaces[a.base.surface_id].draw_count+"."+a.base.surface_id+"@"+a.base.box.left+"x"+a.base.box.top),document.getElementById(a.sc.parent.dump_id).appendChild(d)),a.sc.surfaces[a.base.surface_id].draw_count++)}},SpiceDisplayConn.prototype.draw_helper=function(a){var b,c,d,e,f,g,h,i,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y;if(!a.image_data)return!1;if(b=a.base.box.right-a.base.box.left,c=a.base.box.bottom-a.base.box.top,d=a.image_data,!this.surfaces[a.base.surface_id])return!1;if(e=this.surfaces[a.base.surface_id].canvas,a.mask&&a.mask.bitmap)if(f=this.canvas_get_mask(e.context,a.mask),f&&f.width==d.width){if(g=4*f.width*a.mask.pos.y,h=4*d.width*a.src_area.top,i=4*d.width*a.src_area.bottom,f.width==a.src_area.right-a.src_area.left&&f.height==a.src_area.bottom-a.src_area.top)for(u=h,j=g;i>u;u+=4,j+=4)d.data[u+3]=255^f.data[j+3];else for(u=h,j=g;i>u;u+=4,j+=4)d.data[u+3]=f.data[j+3];a.alpha=255}else f?console.log("can not handle mask_img.width != src_image.width!"):console.log("can not get mask_img!");else a.has_alpha&&void 0==a.alpha&&stripAlpha(d);if(a.msg_type==SPICE_MSG_DISPLAY_DRAW_ROP3&&a.prev_brush){for(k=1==a.prev_brush.type?a.prev_brush.color:0,l=e.context.createImageData(d.width,d.height),u=0;u<d.data.length;u+=4)255!=d.data[u]&&255!=d.data[u+1]&&255!=d.data[u+2]&&(l.data[u]=d.data[u]|k>>16,l.data[u+1]=d.data[u+1]|255&k>>8,l.data[u+2]=d.data[u+2]|255&k,l.data[u+3]=255);d=l}if(a.src_area&&(a.alpha||a.prev_brush||a.rop||a.src_area.left>0||a.src_area.top>0)&&(m=document.createElement("canvas"),n=m.getContext("2d"),m.setAttribute("width",d.width),m.setAttribute("height",d.height),n.putImageData(d,0,0),a.base.box.is_same_size(a.src_area)?(o=b,p=c):(o=a.src_area.right-a.src_area.left<b?a.src_area.right-a.src_area.left:b,p=a.src_area.bottom-a.src_area.top<c?a.src_area.bottom-a.src_area.top:c),d=n.getImageData(a.src_area.left,a.src_area.top,o,p)),d.width<=b&&d.height<=c&&!a.base.box.is_same_size(a.src_area)&&!a.prev_brush&&(q=document.createElement("canvas"),q.setAttribute("width",b),q.setAttribute("height",c),r=q.getContext("2d"),s=d.width,t=d.height,r.putImageData(d,0,0),r.scale(b/s,c/t),r.drawImage(q,0,0,s,t,0,0,s,t),d=r.getImageData(0,0,b,c)),a.rop&&(d=handle_rop(a.rop,e.context,a.base.box,d)),a.msg_type==SPICE_MSG_DISPLAY_DRAW_ALPHA_BLEND){for(l=e.context.getImageData(a.base.box.left,a.base.box.top,b,c),u=0;u<=d.data.length;u+=4)d.data[u]=d.data[u]*a.alpha/255,d.data[u+1]=d.data[u+1]*a.alpha/255,d.data[u+2]=d.data[u+2]*a.alpha/255,d.data[u+3]=d.data[u+3]*a.alpha/255,v=255-d.data[u+3],l.data[u]=d.data[u]+Math.round(v*l.data[u]/255),l.data[u+1]=d.data[u+1]+Math.round(v*l.data[u+1]/255),l.data[u+2]=d.data[u+2]+Math.round(v*l.data[u+2]/255),l.data[u+3]=d.data[u+3]+Math.round(v*l.data[u+3]/255);d=l}if(a.has_alpha&&this.surfaces[a.base.surface_id].format!=SPICE_SURFACE_FMT_32_xRGB)a.base.clip.type!=SPICE_CLIP_TYPE_NONE?console.log("FIXME-2: TODO unhandled putImageDataWithAlpha clip yet....."):putImageDataWithAlpha(e.context,d,a.base.box.left,a.base.box.top,b,c);else if(a.base.clip.type!=SPICE_CLIP_TYPE_NONE)for(handle_clip(a.base.box,a.base.clip.rects),w=a.base.clip.rects.rects,u=0;u<a.base.clip.rects.num_rects;u++)null!=w[u]&&(x=w[u].right-w[u].left,y=w[u].bottom-w[u].top,null==a.alpha?e.context.putImageData(d,a.base.box.left,a.base.box.top,w[u].margin_left,w[u].margin_top,x,y):putImageDataWithAlpha(e.context,d,w[u].left,w[u].top,x,y,w[u].margin_left,w[u].margin_top));else null==a.alpha?e.context.putImageData(d,a.base.box.left,a.base.box.top,0,0,b,c):putImageDataWithAlpha(e.context,d,a.base.box.left,a.base.box.top,b,c);if(a.descriptor&&a.descriptor.flags&SPICE_IMAGE_FLAGS_CACHE_ME&&a.descriptor.type!=SPICE_IMAGE_TYPE_FROM_CACHE&&("cache"in this||(this.cache={}),this.cache[a.descriptor.id]=a.image_data),DUMP_DRAWS&&this.parent.dump_id){if(q=document.createElement("canvas"),q.setAttribute("width",b),q.setAttribute("height",c),q.setAttribute("id",a.tag+"."+this.surfaces[a.base.surface_id].draw_count+"."+a.base.surface_id+"@"+a.base.box.left+"x"+a.base.box.top),r=q.getContext("2d"),a.base.clip.type!=SPICE_CLIP_TYPE_NONE)for(u=0;u<a.base.clip.rects.num_rects;u++)null!=w[u]&&(x=w[u].right-w[u].left,y=w[u].bottom-w[u].top,null==a.alpha?r.putImageData(d,0,0,w[u].margin_left,w[u].margin_top,x,y):putImageDataWithAlpha(r,d,0,0,x,y,w[u].margin_left,w[u].margin_top));else void 0==a.alpha?r.putImageData(d,0,0,0,0,b,c):putImageDataWithAlpha(r,d,0,0,b,c);document.getElementById(this.parent.dump_id).appendChild(q)}return this.surfaces[a.base.surface_id].draw_count++,!0},SpiceDisplayConn.prototype.handle_src_bitmap=function(a,b,c,d){var e,f,g,j,k,l,m,o,p,q,r,s;
if(d&&(b.data.src_bitmap=d),!this.surfaces||!this.surfaces[b.base.surface_id])return!1;if(b.data&&b.data.src_bitmap){if(e="unknow",a==SPICE_MSG_DISPLAY_DRAW_ALPHA_BLEND?(e="DrawAlphaBlend",f=b.data.alpha,g=!b.data.alpha_flags):a==SPICE_MSG_DISPLAY_DRAW_TRANSPARENT?(e="DrawTransparent",b.data.src_color,b.data.true_color):a==SPICE_MSG_DISPLAY_DRAW_BLEND?(e="DrawBlend",g=!0):a==SPICE_MSG_DISPLAY_DRAW_ROP3?(e="DrawRop3",g=!0,f=255,j=b.data.brush):a==SPICE_MSG_DISPLAY_DRAW_COPY&&(e="DrawCopy"),b.data.src_bitmap.descriptor.flags&&b.data.src_bitmap.descriptor.flags!=SPICE_IMAGE_FLAGS_CACHE_ME&&b.data.src_bitmap.descriptor.flags!=SPICE_IMAGE_FLAGS_HIGH_BITS_SET,b.data.src_bitmap.descriptor.type==SPICE_IMAGE_TYPE_QUIC)return k=this.surfaces[b.base.surface_id].canvas,b.data.src_bitmap.quic?(l=convert_spice_quic_to_web(k.context,b.data.src_bitmap.quic),c?l:(void 0==g&&(g=b.data.src_bitmap.quic.type==QUIC_IMAGE_TYPE_RGBA?!0:!1),this.draw_helper({base:b.base,src_area:b.data.src_area,image_data:l,tag:e+"_quic."+b.data.src_bitmap.quic.type,has_alpha:g,descriptor:b.data.src_bitmap.descriptor,alpha:f,rop:b.data.rop_descriptor,prev_brush:j,msg_type:a}))):(this.log_warn("FIXME:  "+e+" could not handle this QUIC file."),!1);if(b.data.src_bitmap.descriptor.type==SPICE_IMAGE_TYPE_FROM_CACHE||b.data.src_bitmap.descriptor.type==SPICE_IMAGE_TYPE_FROM_CACHE_LOSSLESS)return this.cache&&this.cache[b.data.src_bitmap.descriptor.id]?c?this.cache[b.data.src_bitmap.descriptor.id]:this.draw_helper({base:b.base,src_area:b.data.src_area,image_data:this.cache[b.data.src_bitmap.descriptor.id],tag:e+"_cache."+b.data.src_bitmap.descriptor.id,has_alpha:void 0==g?!0:g,descriptor:b.data.src_bitmap.descriptor,alpha:f,rop:b.data.rop_descriptor,prev_brush:j,mask:b.data.mask,msg_type:a}):(this.log_warn("FIXME: "+e+"  did not find image id "+b.data.src_bitmap.descriptor.id+" in cache."),!1);if(b.data.src_bitmap.descriptor.type==SPICE_IMAGE_TYPE_SURFACE)return m=this.surfaces[b.data.src_bitmap.surface_id].canvas.context,this.surfaces[b.base.surface_id].canvas.context,l=m.getImageData(b.data.src_area.left,b.data.src_area.top,b.data.src_area.right-b.data.src_area.left,b.data.src_area.bottom-b.data.src_area.top),o=new SpiceRect,o.top=o.left=0,o.right=l.width,o.bottom=l.height,c?l:this.draw_helper({base:b.base,src_area:o,image_data:l,tag:e+"_surf."+b.data.src_bitmap.surface_id,has_alpha:this.surfaces[b.data.src_bitmap.surface_id].format==SPICE_SURFACE_FMT_32_xRGB?!1:!0,descriptor:b.data.src_bitmap.descriptor,rop:b.data.rop_descriptor,msg_type:a});if(b.data.src_bitmap.descriptor.type==SPICE_IMAGE_TYPE_JPEG){if(!b.data.src_bitmap.jpeg)return this.log_warn("FIXME: "+e+"  could not handle this JPEG file."),!1;for(p="data:image/jpeg,",q=new Image,s=new Uint8Array(b.data.src_bitmap.jpeg.data),this.log_warn("JPEG file size is : "+s.length+"!!!!!!!!!!!!"),r=0;r<s.length;r++)p+="%",s[r]<16&&(p+="0"),p+=s[r].toString(16);return q.o={base:b.base,tag:e+"_jpeg."+b.data.src_bitmap.surface_id,descriptor:b.data.src_bitmap.descriptor,sc:this,top_down:!1},q.onload=handle_draw_jpeg_onload,q.src=p,!0}if(b.data.src_bitmap.descriptor.type==SPICE_IMAGE_TYPE_JPEG_ALPHA){if(!b.data.src_bitmap.jpeg_alpha)return this.log_warn("FIXME: "+e+"  could not handle this JPEG ALPHA file."),!1;for(p="data:image/jpeg,",q=new Image,s=new Uint8Array(b.data.src_bitmap.jpeg_alpha.data),this.log_warn("JPEG_ALPHA file size is : "+s.length+"!!!!!!!!!!!!"),r=0;r<s.length;r++)p+="%",s[r]<16&&(p+="0"),p+=s[r].toString(16);return q.o={base:b.base,tag:e+"_jpeg."+b.data.src_bitmap.surface_id,descriptor:b.data.src_bitmap.descriptor,sc:this,top_down:!1},this.surfaces[b.base.surface_id].format==SPICE_SURFACE_FMT_32_ARGB&&(k=this.surfaces[b.base.surface_id].canvas,q.alpha_img=convert_spice_lz_to_web(k.context,b.data.src_bitmap.jpeg_alpha.alpha)),q.onload=handle_draw_jpeg_onload,q.src=p,!0}return b.data.src_bitmap.descriptor.type==SPICE_IMAGE_TYPE_BITMAP?(k=this.surfaces[b.base.surface_id].canvas,b.data.src_bitmap.bitmap?(l=convert_spice_bitmap_to_web(k.context,b.data.src_bitmap.bitmap))?c?l:(void 0==g&&(g=b.data.src_bitmap.bitmap.format!=SPICE_BITMAP_FMT_RGBA?!1:!0),this.draw_helper({base:b.base,src_area:b.data.src_area,image_data:l,tag:e+"_bitmap."+b.data.src_bitmap.bitmap.format,has_alpha:g,descriptor:b.data.src_bitmap.descriptor,alpha:f,rop:b.data.rop_descriptor,prev_brush:j,mask:b.data.mask,msg_type:a})):(this.log_warn("FIXME: Unable to interpret bitmap of format: "+b.data.src_bitmap.bitmap.format),!1):(this.log_err("null bitmap"),!1)):b.data.src_bitmap.descriptor.type==SPICE_IMAGE_TYPE_LZ_RGB?(k=this.surfaces[b.base.surface_id].canvas,b.data.src_bitmap.lz_rgb?(1!=b.data.src_bitmap.lz_rgb.top_down,(l=convert_spice_lz_to_web(k.context,b.data.src_bitmap.lz_rgb))?c?l:(void 0==g&&(g=b.data.src_bitmap.lz_rgb.type==LZ_IMAGE_TYPE_RGBA?!0:!1),this.draw_helper({base:b.base,src_area:b.data.src_area,image_data:l,tag:e+"_lz_rgb."+b.data.src_bitmap.lz_rgb.type,has_alpha:g,descriptor:b.data.src_bitmap.descriptor,alpha:f,rop:b.data.rop_descriptor,prev_brush:j,mask:b.data.mask,msg_type:a})):(this.log_warn("FIXME: Unable to interpret LZ_RGB of type: "+b.data.src_bitmap.lz_rgb.type),!1)):(this.log_err("null lz_rgb "),!1)):b.data.src_bitmap.descriptor.type==SPICE_IMAGE_TYPE_LZ_PLT?(k=this.surfaces[b.base.surface_id].canvas,b.data.src_bitmap.lz_plt?(l=convert_spice_lz_to_web(k.context,b.data.src_bitmap.lz_plt))?c?l:(void 0==g&&(g=!1),this.draw_helper({base:b.base,src_area:b.data.src_area,image_data:l,tag:e+"_lz_plt."+b.data.src_bitmap.lz_plt.type,has_alpha:g,descriptor:b.data.src_bitmap.descriptor,alpha:f,rop:b.data.rop_descriptor,prev_brush:j,mask:b.data.mask,msg_type:a})):(this.log_warn("FIXME: Unable to interpret LZ_PLT of type: "+b.data.src_bitmap.lz_plt.type),void 0):(this.log_err("null lz_plt "),void 0)):(this.log_warn("FIXME: "+e+"  unhandled image type: "+b.data.src_bitmap.descriptor.type),!1)}return this.log_warn("FIXME: "+e+" no src_bitmap."),!1},SpiceDisplayConn.prototype.canvas_get_mask=function(a,b){var f,g,c=b.bitmap,d=1&b.flags,e=1&c.descriptor.flags;switch(c.descriptor.type){case SPICE_IMAGE_TYPE_BITMAP:f=d&&!e,g=canvas_get_bitmap_mask(a,c.bitmap,f);break;case SPICE_IMAGE_TYPE_FROM_CACHE:g=this.cache[c.descriptor.id],f=0;break;case SPICE_IMAGE_TYPE_FROM_CACHE_LOSSLESS:g=this.cache[c.descriptor.id],f=0;break;default:return NULL}return e&&("cache"in this||(this.cache={}),this.cache[c.descriptor.id]=g),g},SpiceDisplayConn.prototype.canvas_get_image=function(a,b){var c,d,e,g;if(b){if(b.descriptor.flags&&b.descriptor.flags!=SPICE_IMAGE_FLAGS_CACHE_ME&&b.descriptor.flags!=SPICE_IMAGE_FLAGS_HIGH_BITS_SET,b.descriptor.type==SPICE_IMAGE_TYPE_QUIC){if(c=this.surfaces[a.surface_id].canvas,!b.quic)return this.log_warn("FIXME: could not handle this QUIC file."),void 0;d=convert_spice_quic_to_web(c.context,draw.data.src_bitmap.quic)}else if(b.descriptor.type==SPICE_IMAGE_TYPE_FROM_CACHE||b.descriptor.type==SPICE_IMAGE_TYPE_FROM_CACHE_LOSSLESS){if(!this.cache||!this.cache[b.descriptor.id])return this.log_warn("FIXME: did not find image id "+b.descriptor.id+" in cache."),!1;d=this.cache[b.descriptor.id]}else if(b.descriptor.type==SPICE_IMAGE_TYPE_SURFACE)e=this.surfaces[b.surface_id].canvas.context,this.surfaces[a.surface_id].canvas.context,d=e.getImageData(draw.data.src_area.left,draw.data.src_area.top,draw.data.src_area.right-draw.data.src_area.left,draw.data.src_area.bottom-draw.data.src_area.top),g=new SpiceRect,g.top=g.left=0,g.right=d.width,g.bottom=d.height;else if(b.descriptor.type==SPICE_IMAGE_TYPE_BITMAP){if(c=this.surfaces[a.surface_id].canvas,!b.bitmap)return this.log_err("null bitmap"),void 0;if(d=convert_spice_bitmap_to_web(c.context,b.bitmap),!d)return this.log_warn("FIXME: Unable to interpret bitmap of format: "+b.bitmap.format),void 0}else if(b.descriptor.type==SPICE_IMAGE_TYPE_LZ_RGB){if(c=this.surfaces[a.surface_id].canvas,!b.lz_rgb)return this.log_err("null lz_rgb "),void 0;if(d=convert_spice_lz_to_web(c.context,b.lz_rgb),!d)return this.log_warn("FIXME: Unable to interpret LZ_RGB of type: "+b.lz_rgb.type),void 0}else{if(b.descriptor.type!=SPICE_IMAGE_TYPE_LZ_PLT)return this.log_warn("FIXME:  unhandled image type: "+b.descriptor.type),void 0;if(c=this.surfaces[a.surface_id].canvas,!b.lz_plt)return this.log_err("null lz_plt "),void 0;if(d=convert_spice_lz_to_web(c.context,b.lz_plt),!d)return this.log_warn("FIXME: Unable to interpret LZ_PLT of type: "+b.lz_plt.type),void 0}return d}},SpiceDisplayConn.prototype.handle_brush=function(a){var b,c,d,e,f,g,h,i,k,l,m,n,o,p,q,r;if(b=a.area?a.area:a.base.box,c=a.mask_canvas?a.mask_canvas:this.surfaces[a.base.surface_id].canvas,a.bush.type==SPICE_BRUSH_TYPE_SOLID){if(d=16777215&a.bush.color,e="rgb("+(d>>16)+", "+(255&d>>8)+", "+(255&d)+")",c.getContext("2d").fillStyle=e,a.base.clip&&a.base.clip.type!=SPICE_CLIP_TYPE_NONE&&!a.area)for(handle_clip(a.base.box,a.base.clip.rects),f=a.base.clip.rects.rects,g=0;g<a.base.clip.rects.num_rects;g++)null!=f[g]&&c.context.fillRect(b.left+f[g].margin_left,b.top+f[g].margin_top,f[g].right-f[g].left,f[g].bottom-f[g].top);else c.getContext("2d").fillRect(b.left,b.top,b.right-b.left,b.bottom-b.top);if(DUMP_DRAWS&&this.parent.dump_id&&a.base.clip){if(h=document.createElement("canvas"),h.setAttribute("width",b.right-b.left),h.setAttribute("height",b.bottom-b.top),h.setAttribute("id","fillbrush."+a.base.surface_id+"."+this.surfaces[a.base.surface_id].draw_count),h.getContext("2d").fillStyle=e,a.base.clip.type!=SPICE_CLIP_TYPE_NONE)for(f=a.base.clip.rects.rects,g=0;g<a.base.clip.rects.num_rects;g++)null!=f[g]&&h.getContext("2d").fillRect(0,0,f[g].right-f[g].left,f[g].bottom-f[g].top);else h.getContext("2d").fillRect(0,0,b.right-b.left,b.bottom-b.top);document.getElementById(this.parent.dump_id).appendChild(h)}a.base.clip&&this.surfaces[a.base.surface_id].draw_count++}else if(a.bush.type==SPICE_BRUSH_TYPE_PATTERN){if(a.base.clip&&a.base.clip.type!=SPICE_CLIP_TYPE_NONE&&handle_clip(a.base.box,a.base.clip.rects),i=this.canvas_get_image(a.base,a.bush.pattern.pat),!i)return!1;if(1==i.width&&1==i.height)if(e="rgb("+i.data[0]+", "+i.data[1]+", "+i.data[3]+")",c.getContext("2d").fillStyle=e,a.base.clip&&a.base.clip.type!=SPICE_CLIP_TYPE_NONE)for(f=a.base.clip.rects.rects,g=0;g<a.base.clip.rects.num_rects;g++)null!=f[g]&&c.context.fillRect(f[g].left,f[g].top,f[g].right-f[g].left,f[g].bottom-f[g].top);else c.getContext("2d").fillRect(b.left,b.top,b.right-b.left,b.bottom-b.top);else{if(k=b.right-b.left,l=b.bottom-b.top,h=document.createElement("canvas"),m=h.getContext("2d"),a.rop&&a.rop!=SPICE_ROPD_OP_PUT){for(o=i.width*(Math.ceil(k/i.width)+1),p=i.height*(Math.ceil(l/i.height)+1),h.setAttribute("width",o),h.setAttribute("height",p),g=0;o>g;g+=i.width)for(j=0;p>j;j+=i.height)m.putImageData(i,g,j,0,0,i.width,i.height);q=b.left%i.width,r=b.top%i.height,n=m.getImageData(q,r,k,l),n=handle_rop(a.rop,c.context,b,n)}else{for(o=i.width*Math.ceil(k/i.width),p=i.height*Math.ceil(l/i.height),h.setAttribute("width",o),h.setAttribute("height",p),g=0;o>g;g+=i.width)for(j=0;p>j;j+=i.height)m.putImageData(i,g,j,0,0,i.width,i.height);n=m.getImageData(0,0,k,l)}if(n.width<k||n.height<l)return this.log_warn("FIXME-2: source_img size is error in SPICE_BRUSH_TYPE_PATTERN"),!1;if(a.base.clip&&a.base.clip.type!=SPICE_CLIP_TYPE_NONE&&!a.area)for(f=a.base.clip.rects.rects,g=0;g<a.base.clip.rects.num_rects;g++)null!=f[g]&&(k=f[g].right-f[g].left,l=f[g].bottom-f[g].top,c.context.putImageData(n,b.left,b.top,f[g].margin_left,f[g].margin_top,k,l));else k=b.right-b.left,l=b.bottom-b.top,c.context.putImageData(n,b.left,b.top,0,0,k,l)}a.bush.pattern.pat.descriptor&&a.bush.pattern.pat.descriptor.flags&SPICE_IMAGE_FLAGS_CACHE_ME&&("cache"in this||(this.cache={}),this.cache[a.bush.pattern.pat.descriptor.id]=i)}else this.log_warn("FIXME: can't handle brush type: "+a.bush.type);return!0},SpiceDisplayConn.prototype.draw_str_mask_bitmap=function(a){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,b=this.surfaces[a.base.surface_id].canvas,c={};if(!(d=canvas_get_str_mask(b.context,a.str,a.bpp,c)))return console.log("unable to canvas_get_str_mask"),void 0;switch(e={},e.left=c.x,e.top=c.y,e.right=c.x+d.width,e.bottom=c.y+d.height,f={},f.left=0,f.top=0,f.right=d.width,f.bottom=d.height,g=d.width,a.bpp){case 1:g/=8,h=Math.ceil(g),h+=3,h=-4&h;break;case 4:g/=2,h=d.width+3,h=-4&h;break;case 32:g=4*g;break;default:return console.log("unhandle bpp in draw_str_mask_bitmap."),void 0}if(g+=3,g=-4&g,i=document.createElement("canvas"),j=i.getContext("2d"),i.setAttribute("width",d.width),i.setAttribute("height",d.height),this.handle_brush({base:a.base,bush:a.fore_brush,area:f,mask_canvas:i}),k=j.getImageData(0,0,d.width,d.height),copy_bitmap_alpha(d.data,d.height,d.width,h,k.data,g,a.bpp),j.putImageData(k,0,0),a.base.clip.type!=SPICE_CLIP_TYPE_NONE)for(handle_clip(a.base.box,a.base.clip.rects),l=a.base.clip.rects.rects,m=0;m<a.base.clip.rects.num_rects;m++)null!=l[m]&&(n={},rect_area(e,l[m],n),o=n.right-n.left,p=n.bottom-n.top,0>=o||0>=p||b.context.drawImage(i,n.left-e.left,n.top-e.top,o,p,n.left,n.top,o,p));else{if(n={},rect_area(e,a.base.box,n),o=n.right-n.left,p=n.bottom-n.top,0>=o||0>=p)return!0;b.context.drawImage(i,n.left-e.left,n.top-e.top,o,p,n.left,n.top,o,p)}return DUMP_DRAWS&&this.parent.dump_id&&(q=document.createElement("canvas"),q.setAttribute("id","draw_text"),q.setAttribute("width",d.width),q.setAttribute("height",d.height),putImageDataWithAlpha(q.getContext("2d"),k,0,0),document.getElementById(this.parent.dump_id).appendChild(q)),!0};