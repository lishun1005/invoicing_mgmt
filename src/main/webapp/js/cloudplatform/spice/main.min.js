"use strict";function SpiceMainConn(){if(typeof WebSocket==="undefined"){throw new Error("WebSocket unavailable.  You need to use a different browser.")}SpiceConn.apply(this,arguments)}SpiceMainConn.prototype=Object.create(SpiceConn.prototype);SpiceMainConn.prototype.process_channel_message=function(d){if(d.type==SPICE_MSG_MAIN_INIT){this.log_info("Connected to "+this.ws.url);this.report_success("Connected");this.main_init=new SpiceMsgMainInit(d.data);this.connection_id=this.main_init.session_id;if(DEBUG>0){this.log_info("session id "+this.main_init.session_id+" ; display_channels_hint "+this.main_init.display_channels_hint+" ; supported_mouse_modes "+this.main_init.supported_mouse_modes+" ; current_mouse_mode "+this.main_init.current_mouse_mode+" ; agent_connected "+this.main_init.agent_connected+" ; agent_tokens "+this.main_init.agent_tokens+" ; multi_media_time "+this.main_init.multi_media_time+" ; ram_hint "+this.main_init.ram_hint)}this.mouse_mode=this.main_init.current_mouse_mode;if(this.main_init.current_mouse_mode!=SPICE_MOUSE_MODE_CLIENT&&(this.main_init.supported_mouse_modes&SPICE_MOUSE_MODE_CLIENT)){var l=new SpiceMsgcMainMouseModeRequest(SPICE_MOUSE_MODE_CLIENT);var c=new SpiceMiniData();c.build_msg(SPICE_MSGC_MAIN_MOUSE_MODE_REQUEST,l);this.send_msg(c)}var b=this.main_init.agent_connected;var g=this.main_init.agent_tokens;if(b){var m=new SpiceMsgcMainAgentStart(~0);var c=new SpiceMiniData();c.build_msg(SPICE_MSGC_MAIN_AGENT_START,m);this.send_msg(c)}if(b){setTimeout(findDimensions(this),0)}var k=new SpiceMiniData;k.type=SPICE_MSGC_MAIN_ATTACH_CHANNELS;k.size=k.buffer_size();this.send_msg(k);return true}if(d.type==SPICE_MSG_MAIN_MOUSE_MODE){var j=new SpiceMsgMainMouseMode(d.data);DEBUG>0&&this.log_info("Mouse supported modes "+j.supported_modes+"; current "+j.current_mode);this.mouse_mode=j.current_mode;if(this.inputs){this.inputs.mouse_mode=j.current_mode}if(j.supported_modes!=SPICE_MOUSE_MODE_SERVER&&j.current_mode!=SPICE_MOUSE_MODE_CLIENT){var l=new SpiceMsgcMainMouseModeRequest(SPICE_MOUSE_MODE_CLIENT);var c=new SpiceMiniData();c.build_msg(SPICE_MSGC_MAIN_MOUSE_MODE_REQUEST,l);this.send_msg(c);console.log("send a message to change SPICE_MOUSE_MODE into SPICE_MOUSE_MODE_CLIENT")}return true}if(d.type==SPICE_MSG_MAIN_CHANNELS_LIST){var h;var a;DEBUG>0&&console.log("channels");a=new SpiceMsgChannels(d.data);for(h=0;h<a.channels.length;h++){var e={uri:this.ws.url,parent:this,connection_id:this.connection_id,type:a.channels[h].type,chan_id:a.channels[h].id};if(a.channels[h].type==SPICE_CHANNEL_DISPLAY){this.display=new SpiceDisplayConn(e)}else{if(a.channels[h].type==SPICE_CHANNEL_INPUTS){this.inputs=new SpiceInputsConn(e);this.inputs.mouse_mode=this.mouse_mode}else{if(a.channels[h].type==SPICE_CHANNEL_CURSOR){this.cursor=new SpiceCursorConn(e)}else{this.log_err("Channel type "+a.channels[h].type+" unknown.");if(!("extra_channels" in this)){this.extra_channels=[]}this.extra_channels[h]=new SpiceConn(e)}}}}return true}if(d.type==SPICE_MSG_MAIN_AGENT_TOKEN){var f=new SpiceMsgMainAgentTokens(d.data);this.main_init.agent_tokens+=f;return true}if(d.type==SPICE_MSG_MAIN_AGENT_CONNECTED){this.main_init.agent_connected=true;var m=new SpiceMsgcMainAgentStart(~0);var c=new SpiceMiniData();c.build_msg(SPICE_MSGC_MAIN_AGENT_START,m);this.send_msg(c);setTimeout(findDimensions(this),0);return true}if(d.type==SPICE_MSG_MAIN_AGENT_DISCONNECTED){this.main_init.agent_connected=false;return true}if(d.type==SPICE_MSG_MAIN_MIGRATE_BEGIN){this.log_warn("unhadle  SPICE_MSG_MAIN_MIGRATE_BEGIN message in main channel yet.")}else{if(d.type==SPICE_MSG_MAIN_MIGRATE_CANCEL){this.log_warn("unhadle  SPICE_MSG_MAIN_MIGRATE_CANCEL message in main channel yet.")}else{if(d.type==SPICE_MSG_MAIN_MULTI_MEDIA_TIME){this.log_warn("unhadle  SPICE_MSG_MAIN_MULTI_MEDIA_TIME message in main channel yet.")}else{if(d.type==SPICE_MSG_MAIN_AGENT_DATA){this.log_warn("unhadle  SPICE_MSG_MAIN_AGENT_DATA message in main channel yet.")}else{if(d.type==SPICE_MSG_MAIN_MIGRATE_SWITCH_HOST){this.log_warn("unhadle  SPICE_MSG_MAIN_MIGRATE_SWITCH_HOST message in main channel yet.")}else{if(d.type==SPICE_MSG_MAIN_MIGRATE_END){this.log_warn("unhadle  SPICE_MSG_MAIN_MIGRATE_END message in main channel yet.")}else{if(d.type==SPICE_MSG_MAIN_NAME){this.log_warn("unhadle  SPICE_MSG_MAIN_NAME message in main channel yet.")}else{if(d.type==SPICE_MSG_MAIN_UUID){this.log_warn("unhadle  SPICE_MSG_MAIN_UUID message in main channel yet.")}else{if(d.type==SPICE_MSG_END_MAIN){this.log_warn("unhadle  SPICE_MSG_END_MAIN message in main channel yet.")}else{this.log_warn("unhandle msg.type :"+d.type+" in main Channel.")}}}}}}}}}return false};SpiceMainConn.prototype.send_agent_monitors_config=function send_agent_monitors_config(e,b){var a=new VDAgentMonConfig();a.width=e;a.height=b;var c=new VDAgentMonitorsConfig();c.num_of_monitors=1;c.flags=VD_AGENT_CONFIG_MONITORS_FLAG_USE_POS;c.monitors[0]=a;var f=new VDAgentMessage();f.build_msg(c,VD_AGENT_MONITORS_CONFIG);var d=new SpiceMiniData();d.build_msg(SPICE_MSGC_MAIN_AGENT_DATA,f);this.send_msg(d)};SpiceMainConn.prototype.stop=function(b){this.state="closing";if(this.inputs){this.inputs.cleanup();this.inputs=undefined}if(this.cursor){this.cursor.cleanup();this.cursor=undefined}if(this.display){this.display.cleanup();this.display.destroy_surfaces();this.display=undefined}this.cleanup();if("extra_channels" in this){for(var a in this.extra_channels){this.extra_channels[a].cleanup()}}this.extra_channels=undefined};function init_guest_display(){return true}function findDimensions(a){return function(){var c=0;var b=0;if(window.innerWidth){c=window.innerWidth}else{if((document.body)&&(document.body.clientWidth)){c=document.body.clientWidth}}if(window.innerHeight){b=window.innerHeight}else{if((document.body)&&(document.body.clientHeight)){b=document.body.clientHeight}}if(document.documentElement&&document.documentElement.clientHeight&&document.documentElement.clientWidth){b=document.documentElement.clientHeight-1;c=document.documentElement.clientWidth-1}if(a.display&&a.display.surfaces&&a.display.surfaces[0]){if(a.display.surfaces[0].width!=c||a.display.surfaces[0].height!=b){a.send_agent_monitors_config(c,b)}}else{a.send_agent_monitors_config(c,b)}if(a.ws){if(a.main_init.agent_connected){setTimeout(findDimensions(a),AGENT_MONITORS_TIMEOUT)}}}};
